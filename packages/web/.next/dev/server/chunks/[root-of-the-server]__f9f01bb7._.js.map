{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/config.ts"],"sourcesContent":["/**\n * Shared configuration constants for Excel processing\n * Centralizes all magic numbers, field mappings, and hardcoded values\n * Used by both desktop and web implementations\n */\n\n/**\n * Row Expansion Configuration\n * Defines the hierarchical structure: Campaign Line ‚Üí Ad Groups ‚Üí Creative Lines\n *\n * IMPORTANT: Ad group count is now DYNAMIC based on unique audience values\n * in the blocking chart, not hardcoded by platform\n */\nexport const ROW_EXPANSION_CONFIG = {\n  // Always 5 creative lines per ad group\n  CREATIVES_PER_AD_GROUP: 5,\n\n  // Merge level definitions (which fields merge at which level in TRAFFIC SHEET)\n  MERGE_LEVELS: {\n    // Campaign-level fields: span all rows in traffic sheet (varies by ad group count)\n    CAMPAIGN: [\n      'channel',\n      'platform',\n      'mediaType',\n      'objective',\n      'startDate',\n      'endDate',\n      'grossBudget',\n      'netBudget',\n      'language',\n      'placements',\n      'buyType',\n    ] as const,\n\n    // Ad Group-level fields: span 5 rows each (merged across creative lines)\n    AD_GROUP: [\n      'audience',\n      'accuticsCampaignName',\n      'targeting',\n      'target',\n      'kpi',\n    ] as const,\n\n    // Creative-level fields: no merging (unique per row)\n    CREATIVE: ['creativeName', 'creativeFormat', 'adFormat'] as const,\n  },\n\n  // Traffic sheet merge spans (for generation)\n  AD_GROUP_MERGE_SPAN: 5, // Ad group-level fields span 5 rows\n  CREATIVE_MERGE_SPAN: 1, // Creative-level fields don't merge\n} as const;\n\n/**\n * Demographic Extraction Configuration\n * Used to extract demographic codes from Target field for Brand Say Digital\n */\nexport const DEMOGRAPHIC_CONFIG = {\n  // Regex pattern to extract demographic codes from Target field\n  // Matches patterns like: W25-49, M18-44, A18-65, F21-35\n  // Format: [Gender/Age Code][Lower Age]-[Upper Age]\n  DEMO_PATTERN: /\\b([MWFA])(\\d{2})-(\\d{2})\\b/g,\n\n  // Gender/Age code mappings\n  GENDER_CODES: {\n    M: 'Men', // Men/Males\n    W: 'Women', // Women\n    F: 'Women', // Females (alternative)\n    A: 'Adults', // Adults (all genders)\n  } as const,\n\n  // Fallback if no demographic pattern found\n  DEFAULT_DEMO: 'A18+',\n} as const;\n\n/**\n * Traffic Sheet Generation Configuration\n */\nexport const TRAFFIC_SHEET_CONFIG = {\n  // Row expansion\n  CREATIVES_PER_AD_GROUP: ROW_EXPANSION_CONFIG.CREATIVES_PER_AD_GROUP,\n\n  // Row positions\n  HEADER_LABEL_ROW: 8,\n  FIRST_DATA_ROW: 9,\n  TEMPLATE_START_ROW: 9,\n\n  // Header area (rows without borders)\n  HEADER_AREA_START_ROW: 1,\n  HEADER_AREA_END_ROW: 7,\n\n  // Border configuration by tab\n  BORDER_CONFIG: {\n    'Brand Say Digital': {\n      start: 2, // Column B\n      end: 21, // Column U (HEADLINE - last column in template)\n      exclude: [] as number[],\n    },\n    'Brand Say Social': {\n      start: 2, // Column B\n      end: 26, // Column Z\n      exclude: [] as number[],\n    },\n    'Other Say Social': {\n      start: 2, // Column B\n      end: 24, // Column X\n      exclude: [] as number[],\n    },\n  },\n} as const;\n\n/**\n * Blocking Chart Parsing Configuration\n */\nexport const PARSING_CONFIG = {\n  // Header detection\n  MIN_HEADER_CELLS: 3, // Minimum non-empty cells to consider a row as header\n  MAX_METADATA_ROWS: 10, // Maximum rows to scan for metadata before header\n\n  // Required header keywords for validation\n  REQUIRED_HEADER_KEYWORDS: ['channel', 'platform', 'objective'] as const,\n\n  // Budget column exact matches (strict matching to avoid false positives)\n  BUDGET_COLUMN_NAMES: [\n    'Gross Budget',\n    'Net Budget',\n    'Gross Media Cost',\n    'Media Cost',\n    'Working Media Budget',\n    'Budget',\n  ] as const,\n\n  // Impressions column names for campaign line detection\n  IMPRESSIONS_COLUMN_NAMES: [\n    'Est. Impressions',\n    'Estimated Impressions',\n    'Impressions',\n    'Impressions/GRPs',\n  ] as const,\n\n  // Placements column name variations (try in order)\n  PLACEMENTS_COLUMN_NAMES: [\n    'Campaign Details - Placements', // Primary (unified template)\n    'Placements', // Fallback\n    'Placement', // Alternative spelling\n  ] as const,\n\n  // Audience column name variations (for ad group detection)\n  AUDIENCE_COLUMN_NAMES: [\n    'Targeting',          // Primary field\n    'Target',             // Alternative\n    'Audience',           // Alternative\n    'Target Audience',    // Alternative\n  ] as const,\n\n  // Minimum fields for valid campaign line\n  MIN_CAMPAIGN_LINE_FIELDS: 4,\n} as const;\n\n/**\n * Campaign Line Detection Configuration\n * Defines which columns must be merged together to identify a campaign line\n */\nexport const CAMPAIGN_LINE_DETECTION_CONFIG = {\n  // These columns MUST have matching merge spans to identify a campaign line\n  REQUIRED_MERGE_COLUMNS: [\n    'Est. Impressions',             // Primary indicator\n    'Gross Budget',                 // Primary indicator\n    'Campaign Details - Placements', // Primary indicator (triple-merge detection)\n  ] as const,\n\n  // Alternative budget columns to check if primary not found\n  BUDGET_ALTERNATIVES: [\n    'Net Budget',\n    'Gross Media Cost',\n    'Working Media Budget',\n  ] as const,\n\n  // Patterns to exclude from campaign line detection (summary/total rows)\n  EXCLUSION_PATTERNS: [\n    'total',\n    'subtotal',\n    'summary',\n    'variance',\n    'grand total',\n    'mpa budget',\n  ] as const,\n} as const;\n\n/**\n * Ad Group Detection Configuration (NEW - Audience-Based)\n * Defines how ad groups are identified within campaign lines\n */\nexport const AD_GROUP_DETECTION_CONFIG = {\n  // Primary field to group by for ad group detection\n  PRIMARY_GROUPING_FIELD: 'audience',\n\n  // Fallback fields if primary is empty\n  FALLBACK_GROUPING_FIELDS: ['targeting', 'target'] as const,\n\n  // Default ad group name if all grouping fields are empty\n  DEFAULT_AD_GROUP_NAME: 'Unspecified',\n\n  // Minimum rows per ad group (if blocking chart has fewer, pad with empty creatives)\n  MIN_ROWS_PER_AD_GROUP: 5,\n\n  // Maximum rows per ad group (if blocking chart has more, create additional ad groups)\n  MAX_ROWS_PER_AD_GROUP: 5,\n} as const;\n\n/**\n * Categorization Rules Configuration\n * Determines which traffic sheet tab a campaign line goes to\n */\nexport const CATEGORIZATION_CONFIG = {\n  // Channel keywords for Brand Say Digital\n  BRAND_SAY_DIGITAL_KEYWORDS: [\n    'digital video',\n    'digital display',\n    'digital audio',\n    'programmatic',\n    'ctv',\n    'audio',\n    'ooh',\n  ] as const,\n\n  // Social platform identifiers for Brand Say Social\n  SOCIAL_PLATFORMS: [\n    'meta',\n    'facebook',\n    'instagram',\n    'fb',\n    'ig',\n    'tiktok',\n    'tik tok',\n    'pinterest',\n    'pin',\n    'reddit',\n    'snapchat',\n    'snap',\n    'twitter',\n    'x.com',\n    'linkedin',\n  ] as const,\n\n  // Influencer detection keywords for Other Say Social\n  INFLUENCER_KEYWORDS: ['influencer', 'creator'] as const,\n\n  // Section header patterns (excluded from output)\n  SECTION_HEADER_PATTERNS: [\n    'digital video',\n    'digital display',\n    'digital audio',\n    'paid social',\n    'social',\n    'video',\n    'display',\n    'audio',\n  ] as const,\n\n  // Summary row patterns (excluded from tactics)\n  SUMMARY_ROW_PATTERNS: [\n    'mpa budget',\n    'variance',\n    'grand total',\n  ] as const,\n\n  // Non-digital channels excluded from traffic sheet generation\n  // These appear in verification but don't generate traffic sheet rows\n  EXCLUDED_CHANNEL_KEYWORDS: {\n    OOH: ['pattison', 'astral', 'out of home', 'ooh', 'billboard', 'transit', 'outdoor'] as const,\n    TV: ['linear tv', 'television', 'broadcast tv', 'tv broadcast', 'linear television'] as const,\n    RADIO: ['radio', 'am/fm', 'am fm'] as const,\n    PRINT: ['print', 'magazine', 'newspaper', 'press'] as const,\n  } as const,\n} as const;\n\n/**\n * Styling Configuration\n * Excel cell styling rules\n */\nexport const STYLE_CONFIG = {\n  // Header labels that should preserve blue styling\n  HEADER_LABELS: [\n    'OBJECTIVE',\n    'TACTIC',\n    'PLATFORM',\n    'DEMO',\n    'TARGETING DETAILS',\n  ] as const,\n\n  // Template text that should be cleared before writing data\n  TEMPLATE_TEXT_TO_CLEAR: [\n    'Accutics Campaign Name',\n    'Audience',\n    'Accutics Ad Set Name',\n    'CREATIVE TYPE',\n    'DEVICE',\n    'GEO',\n    'LANGUAGE',\n    'START DATE',\n    'END DATE',\n    'KPI Metric',\n  ] as const,\n\n  // Columns that should be merged vertically in traffic sheet blocks\n  MERGEABLE_COLUMN_HEADERS: [\n    'CREATIVE TYPE',\n    'DEVICE',\n    'GEO',\n    'BUY TYPE',\n    'BID TYPE',\n    'AD SET BUDGET',\n    'TARGETING SUMMARY',\n    'CREATIVETYPE', // Brand Say Digital lowercase variant\n  ] as const,\n} as const;\n\n/**\n * Validation Configuration\n * Rules for data quality validation\n */\nexport const VALIDATION_CONFIG = {\n  // Required fields for a valid campaign line\n  REQUIRED_CAMPAIGN_FIELDS: ['channel', 'platform'] as const,\n\n  // Numeric fields that should be validated\n  NUMERIC_FIELDS: [\n    'budget',\n    'grossBudget',\n    'netBudget',\n    'estImpressions',\n    'estCpm',\n    'adServing',\n    'dvCost',\n    'buffer',\n  ] as const,\n\n  // Date fields that should be validated\n  DATE_FIELDS: ['startDate', 'endDate'] as const,\n} as const;\n\n/**\n * Date Formatting Configuration\n */\nexport const DATE_CONFIG = {\n  // Month abbreviations for traffic sheet format (D-MMM-YY)\n  // Example: \"5-Jan-25\" for January 5, 2025\n  MONTH_NAMES: [\n    'Jan',\n    'Feb',\n    'Mar',\n    'Apr',\n    'May',\n    'Jun',\n    'Jul',\n    'Aug',\n    'Sept',\n    'Oct',\n    'Nov',\n    'Dec',\n  ] as const,\n} as const;\n\n/**\n * Template Detection Configuration\n * For identifying blocking chart template versions\n */\nexport const TEMPLATE_CONFIG = {\n  // Minimum extended columns to qualify as \"Extended\" template\n  MIN_EXTENDED_COLUMNS: 2,\n\n  // Detection priority (higher number = higher priority)\n  TEMPLATE_PRIORITY: {\n    'unilever-extended': 2,\n    'unilever-standard': 1,\n  },\n\n  // Maximum rows to scan for headers when detecting template\n  MAX_ROWS_TO_SCAN: 20,\n\n  // Prefer first visible tab if valid template found\n  PREFER_FIRST_VISIBLE: true,\n\n  // Only show visible tabs in picker UI\n  SHOW_HIDDEN_TABS: false,\n} as const;\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED;;;;;;CAMC;;;;;;;;;;;;;;;;;;;;;;;;AACM,MAAM,uBAAuB;IAClC,uCAAuC;IACvC,wBAAwB;IAExB,+EAA+E;IAC/E,cAAc;QACZ,mFAAmF;QACnF,UAAU;YACR;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD;QAED,yEAAyE;QACzE,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QAED,qDAAqD;QACrD,UAAU;YAAC;YAAgB;YAAkB;SAAW;IAC1D;IAEA,6CAA6C;IAC7C,qBAAqB;IACrB,qBAAqB;AACvB;AAMO,MAAM,qBAAqB;IAChC,+DAA+D;IAC/D,wDAAwD;IACxD,mDAAmD;IACnD,cAAc;IAEd,2BAA2B;IAC3B,cAAc;QACZ,GAAG;QACH,GAAG;QACH,GAAG;QACH,GAAG;IACL;IAEA,2CAA2C;IAC3C,cAAc;AAChB;AAKO,MAAM,uBAAuB;IAClC,gBAAgB;IAChB,wBAAwB,qBAAqB,sBAAsB;IAEnE,gBAAgB;IAChB,kBAAkB;IAClB,gBAAgB;IAChB,oBAAoB;IAEpB,qCAAqC;IACrC,uBAAuB;IACvB,qBAAqB;IAErB,8BAA8B;IAC9B,eAAe;QACb,qBAAqB;YACnB,OAAO;YACP,KAAK;YACL,SAAS,EAAE;QACb;QACA,oBAAoB;YAClB,OAAO;YACP,KAAK;YACL,SAAS,EAAE;QACb;QACA,oBAAoB;YAClB,OAAO;YACP,KAAK;YACL,SAAS,EAAE;QACb;IACF;AACF;AAKO,MAAM,iBAAiB;IAC5B,mBAAmB;IACnB,kBAAkB;IAClB,mBAAmB;IAEnB,0CAA0C;IAC1C,0BAA0B;QAAC;QAAW;QAAY;KAAY;IAE9D,yEAAyE;IACzE,qBAAqB;QACnB;QACA;QACA;QACA;QACA;QACA;KACD;IAED,uDAAuD;IACvD,0BAA0B;QACxB;QACA;QACA;QACA;KACD;IAED,mDAAmD;IACnD,yBAAyB;QACvB;QACA;QACA;KACD;IAED,2DAA2D;IAC3D,uBAAuB;QACrB;QACA;QACA;QACA;KACD;IAED,yCAAyC;IACzC,0BAA0B;AAC5B;AAMO,MAAM,iCAAiC;IAC5C,2EAA2E;IAC3E,wBAAwB;QACtB;QACA;QACA;KACD;IAED,2DAA2D;IAC3D,qBAAqB;QACnB;QACA;QACA;KACD;IAED,wEAAwE;IACxE,oBAAoB;QAClB;QACA;QACA;QACA;QACA;QACA;KACD;AACH;AAMO,MAAM,4BAA4B;IACvC,mDAAmD;IACnD,wBAAwB;IAExB,sCAAsC;IACtC,0BAA0B;QAAC;QAAa;KAAS;IAEjD,yDAAyD;IACzD,uBAAuB;IAEvB,oFAAoF;IACpF,uBAAuB;IAEvB,sFAAsF;IACtF,uBAAuB;AACzB;AAMO,MAAM,wBAAwB;IACnC,yCAAyC;IACzC,4BAA4B;QAC1B;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,mDAAmD;IACnD,kBAAkB;QAChB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,qDAAqD;IACrD,qBAAqB;QAAC;QAAc;KAAU;IAE9C,iDAAiD;IACjD,yBAAyB;QACvB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,+CAA+C;IAC/C,sBAAsB;QACpB;QACA;QACA;KACD;IAED,8DAA8D;IAC9D,qEAAqE;IACrE,2BAA2B;QACzB,KAAK;YAAC;YAAY;YAAU;YAAe;YAAO;YAAa;YAAW;SAAU;QACpF,IAAI;YAAC;YAAa;YAAc;YAAgB;YAAgB;SAAoB;QACpF,OAAO;YAAC;YAAS;YAAS;SAAQ;QAClC,OAAO;YAAC;YAAS;YAAY;YAAa;SAAQ;IACpD;AACF;AAMO,MAAM,eAAe;IAC1B,kDAAkD;IAClD,eAAe;QACb;QACA;QACA;QACA;QACA;KACD;IAED,2DAA2D;IAC3D,wBAAwB;QACtB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,mEAAmE;IACnE,0BAA0B;QACxB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;AACH;AAMO,MAAM,oBAAoB;IAC/B,4CAA4C;IAC5C,0BAA0B;QAAC;QAAW;KAAW;IAEjD,0CAA0C;IAC1C,gBAAgB;QACd;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,uCAAuC;IACvC,aAAa;QAAC;QAAa;KAAU;AACvC;AAKO,MAAM,cAAc;IACzB,0DAA0D;IAC1D,0CAA0C;IAC1C,aAAa;QACX;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;AACH;AAMO,MAAM,kBAAkB;IAC7B,6DAA6D;IAC7D,sBAAsB;IAEtB,uDAAuD;IACvD,mBAAmB;QACjB,qBAAqB;QACrB,qBAAqB;IACvB;IAEA,2DAA2D;IAC3D,kBAAkB;IAElB,mDAAmD;IACnD,sBAAsB;IAEtB,sCAAsC;IACtC,kBAAkB;AACpB","debugId":null}},
    {"offset": {"line": 491, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/utils/PlatformClassifier.ts"],"sourcesContent":["/**\n * Platform Classifier Utility\n * Centralizes all platform-specific logic that was previously scattered across\n * parseBlockingChart.ts, generateTrafficSheet.ts, and trafficSheetWriter.ts\n */\n\nimport type { TrafficSheetTab } from '../types';\n\n/**\n * Platform category for traffic sheet tab routing\n */\nexport type PlatformCategory = 'digital' | 'social' | 'influencer';\n\n/**\n * Determine which traffic sheet tab a campaign line should go to\n * Logic:\n * 1. Check channel first\n * 2. If channel is \"Other Say Social\" or contains \"influencer\"/\"creator\" ‚Üí Other Say Social\n * 3. For social channels, check ad format for \"influencer\" ‚Üí Other Say Social\n * 4. Social platforms without influencer ‚Üí Brand Say Social\n * 5. Everything else ‚Üí Brand Say Digital\n *\n * @param platform - Platform name from blocking chart\n * @param channel - Channel name from blocking chart (optional)\n * @param adFormat - Ad Format from blocking chart (optional)\n * @returns Traffic sheet tab name\n */\nexport function getTrafficSheetTab(platform: string, channel?: string, adFormat?: string): TrafficSheetTab {\n  const platformLower = (platform || '').toLowerCase();\n  const channelLower = (channel || '').toLowerCase();\n  const adFormatLower = (adFormat || '').toLowerCase();\n\n  // Step 1: Check channel for explicit \"Other Say Social\" or influencer/creator keywords\n  if (channelLower.includes('other say social') ||\n      channelLower.includes('influencer') ||\n      channelLower.includes('creator')) {\n    return 'Other Say Social';\n  }\n\n  // Step 2: Check if it's a social platform\n  const isSocialPlatform = (\n    platformLower.includes('meta') ||\n    platformLower.includes('facebook') ||\n    platformLower.includes('instagram') ||\n    platformLower.includes('tiktok') ||\n    platformLower.includes('pinterest') ||\n    platformLower.includes('snapchat') ||\n    platformLower.includes('twitter') ||\n    platformLower.includes('x.com') ||\n    platformLower.includes('linkedin') ||\n    platformLower.includes('reddit')\n  );\n\n  // Step 3: For social platforms, check ad format for influencer content\n  if (isSocialPlatform) {\n    if (adFormatLower.includes('influencer') || adFormatLower.includes('creator')) {\n      return 'Other Say Social';\n    }\n    return 'Brand Say Social';\n  }\n\n  // Step 4: Everything else ‚Üí Brand Say Digital (programmatic, display, video, audio)\n  return 'Brand Say Digital';\n}\n\n/**\n * Get platform category for internal logic\n *\n * @param platform - Platform name from blocking chart\n * @returns Platform category\n */\nexport function getPlatformCategory(platform: string): PlatformCategory {\n  const platformLower = (platform || '').toLowerCase();\n\n  // Social platforms\n  if (\n    platformLower.includes('meta') ||\n    platformLower.includes('facebook') ||\n    platformLower.includes('instagram') ||\n    platformLower.includes('tiktok') ||\n    platformLower.includes('pinterest') ||\n    platformLower.includes('snapchat') ||\n    platformLower.includes('twitter') ||\n    platformLower.includes('linkedin') ||\n    platformLower.includes('reddit')\n  ) {\n    return 'social';\n  }\n\n  // Influencer\n  if (\n    platformLower.includes('influencer') ||\n    platformLower.includes('creator')\n  ) {\n    return 'influencer';\n  }\n\n  // Digital (programmatic, display, video, audio)\n  return 'digital';\n}\n\n/**\n * Determine default placements based on platform\n * Used when placements field is empty in blocking chart\n *\n * @param platform - Platform name from blocking chart\n * @param defaultValue - Fallback value if no platform-specific default exists\n * @returns Platform-appropriate placement string\n */\nexport function getDefaultPlacements(platform: string, defaultValue: string = ''): string {\n  const platformLower = (platform || '').toLowerCase();\n\n  if (platformLower.includes('tiktok')) {\n    return 'In-Feed';\n  }\n\n  if (platformLower.includes('meta') || platformLower.includes('facebook') || platformLower.includes('instagram')) {\n    return 'Feeds, Stories, Reels';\n  }\n\n  if (platformLower.includes('pinterest')) {\n    return defaultValue; // Pinterest uses ad format from creative line\n  }\n\n  if (platformLower.includes('snapchat')) {\n    return 'Snap Ads | Story Ads';\n  }\n\n  if (platformLower.includes('linkedin')) {\n    return 'Feed | Sponsored Content';\n  }\n\n  if (platformLower.includes('twitter') || platformLower.includes('x.com')) {\n    return 'Timeline | Trends';\n  }\n\n  // For programmatic/digital, use the provided value or default\n  return defaultValue;\n}\n\n/**\n * Check if a channel should be excluded from traffic sheet\n * (OOH, TV, Radio, Print are planning-only channels)\n *\n * @param channel - Channel name from blocking chart\n * @returns True if channel should be excluded\n */\nexport function isExcludedChannel(channel: string): boolean {\n  const channelLower = (channel || '').toLowerCase();\n\n  return (\n    channelLower.includes('ooh') ||\n    channelLower.includes('out of home') ||\n    channelLower.includes('outdoor') ||\n    channelLower.includes('tv') ||\n    channelLower.includes('television') ||\n    channelLower.includes('radio') ||\n    channelLower.includes('print') ||\n    channelLower.includes('newspaper') ||\n    channelLower.includes('magazine')\n  );\n}\n\n/**\n * Get exclusion reason for excluded channels\n *\n * @param channel - Channel name from blocking chart\n * @returns Exclusion reason string or undefined\n */\nexport function getExclusionReason(channel: string): string | undefined {\n  const channelLower = (channel || '').toLowerCase();\n\n  if (channelLower.includes('ooh') || channelLower.includes('out of home') || channelLower.includes('outdoor')) {\n    return 'OOH (Out of Home) - planning only';\n  }\n\n  if (channelLower.includes('tv') || channelLower.includes('television')) {\n    return 'TV - planning only';\n  }\n\n  if (channelLower.includes('radio')) {\n    return 'Radio - planning only';\n  }\n\n  if (channelLower.includes('print') || channelLower.includes('newspaper') || channelLower.includes('magazine')) {\n    return 'Print - planning only';\n  }\n\n  return undefined;\n}\n\n/**\n * Check if platform is a social platform\n *\n * @param platform - Platform name from blocking chart\n * @returns True if platform is social\n */\nexport function isSocialPlatform(platform: string): boolean {\n  return getPlatformCategory(platform) === 'social';\n}\n\n/**\n * Check if platform is programmatic/digital\n *\n * @param platform - Platform name from blocking chart\n * @returns True if platform is programmatic\n */\nexport function isProgrammaticPlatform(platform: string): boolean {\n  const platformLower = (platform || '').toLowerCase();\n\n  return (\n    platformLower.includes('trade desk') ||\n    platformLower.includes('tradedesk') ||\n    platformLower.includes('dv360') ||\n    platformLower.includes('display & video 360') ||\n    platformLower.includes('amazon') ||\n    platformLower.includes('programmatic')\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 598, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/utils/FieldNormalizer.ts"],"sourcesContent":["/**\n * Field Normalizer Utility\n * Consolidates all field name normalization logic into a single function\n * Replaces scattered normalization across parseBlockingChart, generateTrafficSheet, and trafficSheetWriter\n */\n\n/**\n * Normalize a field name to lowercase alphanumeric (camelCase style)\n * Removes special characters, spaces, and converts to camelCase\n *\n * Examples:\n *   \"Campaign Details - Placements\" ‚Üí \"campaigndetailsplacements\"\n *   \"Start Date\" ‚Üí \"startdate\"\n *   \"Gross Budget\" ‚Üí \"grossbudget\"\n *   \"Est. Impressions\" ‚Üí \"estimpressions\"\n *\n * @param name - Field name to normalize\n * @returns Normalized field name\n */\nexport function normalizeFieldName(name: string): string {\n  if (!name) return '';\n\n  return name\n    .toLowerCase()\n    .replace(/[^a-z0-9]+/g, '') // Remove all non-alphanumeric characters\n    .trim();\n}\n\n/**\n * Normalize field name but preserve camelCase structure\n * Used when you want to maintain readability in variable names\n *\n * Examples:\n *   \"Campaign Details - Placements\" ‚Üí \"campaignDetailsPlacements\"\n *   \"Start Date\" ‚Üí \"startDate\"\n *   \"Gross Budget\" ‚Üí \"grossBudget\"\n *\n * @param name - Field name to normalize\n * @returns CamelCase normalized field name\n */\nexport function normalizeFieldNameCamelCase(name: string): string {\n  if (!name) return '';\n\n  const words = name\n    .split(/[^a-zA-Z0-9]+/)\n    .filter(word => word.length > 0);\n\n  if (words.length === 0) return '';\n\n  return words[0].toLowerCase() +\n    words.slice(1)\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join('');\n}\n\n/**\n * Create a mapping of normalized field names to original names\n * Useful for reverse lookup and debugging\n *\n * @param fieldNames - Array of original field names\n * @returns Map of normalized ‚Üí original names\n */\nexport function createFieldNameMap(fieldNames: string[]): Map<string, string> {\n  const map = new Map<string, string>();\n\n  for (const name of fieldNames) {\n    const normalized = normalizeFieldName(name);\n    if (normalized) {\n      map.set(normalized, name);\n    }\n  }\n\n  return map;\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED;;;;;;;;;;;;CAYC;;;;;;;;AACM,SAAS,mBAAmB,IAAY;IAC7C,IAAI,CAAC,MAAM,OAAO;IAElB,OAAO,KACJ,WAAW,GACX,OAAO,CAAC,eAAe,IAAI,yCAAyC;KACpE,IAAI;AACT;AAcO,SAAS,4BAA4B,IAAY;IACtD,IAAI,CAAC,MAAM,OAAO;IAElB,MAAM,QAAQ,KACX,KAAK,CAAC,iBACN,MAAM,CAAC,CAAA,OAAQ,KAAK,MAAM,GAAG;IAEhC,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAE/B,OAAO,KAAK,CAAC,EAAE,CAAC,WAAW,KACzB,MAAM,KAAK,CAAC,GACT,GAAG,CAAC,CAAA,OAAQ,KAAK,MAAM,CAAC,GAAG,WAAW,KAAK,KAAK,KAAK,CAAC,GAAG,WAAW,IACpE,IAAI,CAAC;AACZ;AASO,SAAS,mBAAmB,UAAoB;IACrD,MAAM,MAAM,IAAI;IAEhB,KAAK,MAAM,QAAQ,WAAY;QAC7B,MAAM,aAAa,mBAAmB;QACtC,IAAI,YAAY;YACd,IAAI,GAAG,CAAC,YAAY;QACtB;IACF;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 647, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/utils/FieldMapper.ts"],"sourcesContent":["/**\n * Field Mapper Utility\n * Centralizes all field mappings between blocking chart columns and traffic sheet columns\n * Replaces scattered mapping logic across parseBlockingChart, generateTrafficSheet, and trafficSheetWriter\n */\n\nimport type { TrafficSheetTab } from '../types';\nimport { normalizeFieldName } from './FieldNormalizer';\n\n/**\n * Blocking chart column names (exact matches from blocking chart)\n */\nexport const BLOCKING_CHART_COLUMNS = {\n  // Core tactical information\n  CHANNEL: 'Channel',\n  PLATFORM: 'Platform',\n  MEDIA_TYPE: 'Media type',\n  BUY_TYPE: 'Buy Type',\n  OBJECTIVE: 'Objective',\n\n  // Campaign details\n  PLACEMENTS: 'Campaign Details - Placements',\n  ACCUTICS_CAMPAIGN_NAME: 'Accutics Campaign Name',\n  TAGS_REQUIRED: 'Tags Required',\n  MEASUREMENT: 'Measurement',\n  LANGUAGE: 'Language',\n  AD_FORMAT: 'Ad Format',\n\n  // KPI information\n  KPI: 'KPI',\n  KPI_VALUE: 'KPI Value',\n  TARGET: 'Target',\n  TARGETING: 'Targeting',  // Sometimes used instead of Target\n\n  // Budget and metrics (campaign line identifiers)\n  EST_CPM: 'Est. CPM',\n  EST_IMPRESSIONS: 'Est. Impressions',\n  GROSS_BUDGET: 'Gross Budget',\n  NET_BUDGET: 'Net Budget',\n  AD_SERVING: 'Ad Serving',\n  DV_COST: 'DV Cost',\n  BUFFER: 'Buffer (+30%)',\n\n  // Flight dates\n  START_DATE: 'Start Date',\n  END_DATE: 'End Date',\n} as const;\n\n/**\n * Campaign line detection columns (must be merged together)\n */\nexport const CAMPAIGN_LINE_INDICATORS = [\n  'Est. Impressions',  // Primary indicator\n  'Gross Budget',      // Primary indicator\n  'Campaign Details - Placements'  // Primary indicator (added for triple-merge detection)\n] as const;\n\n/**\n * Blocking chart to internal field name mappings\n * Handles all known column name variations\n */\nexport const BLOCKING_CHART_FIELD_MAPPINGS: Record<string, string> = {\n  // Core fields\n  'Channel': 'channel',\n  'Platform': 'platform',\n  'Media type': 'mediaType',\n  'Media Type': 'mediaType',\n  'Buy Type': 'buyType',\n  'Objective': 'objective',\n\n  // Placements/Tactic variations\n  'Campaign Details - Placements': 'placements',\n  'Placements': 'placements',\n  'Placement': 'placements',\n\n  // Accutics naming\n  'Accutics Campaign Name': 'accuticsCampaignName',\n\n  // Metadata\n  'Tags Required': 'tagsRequired',\n  'Measurement': 'measurement',\n  'Language': 'language',\n\n  // Creative format\n  'Ad Format': 'adFormat',\n  'Creative Format': 'creativeFormat',\n\n  // Targeting/KPI\n  'KPI': 'kpi',\n  'KPI Metric': 'kpi',\n  'KPI Value': 'kpiValue',\n  'Target': 'target',\n  'Targeting': 'targeting',\n\n  // Budget fields\n  'Est. CPM': 'estCpm',\n  'Estimated CPM': 'estCpm',\n  'Estimated\\nCPM': 'estCpm',\n  'Est. Impressions': 'estImpressions',\n  'Impressions/GRPs': 'estImpressions',\n  'Gross Budget': 'grossBudget',\n  'Gross Media Cost': 'grossBudget',\n  'Net Budget': 'netBudget',\n  'Working Media Budget': 'netBudget',\n  'Media Cost': 'grossBudget',\n  'Ad Serving': 'adServing',\n  'DV Cost': 'dvCost',\n  'Media Fee Total': 'mediaFeeTotal',\n  'Buffer (+30%)': 'buffer',\n\n  // Dates\n  'Start Date': 'startDate',\n  'End Date': 'endDate',\n\n  // Additional fields\n  'Learning Agenda': 'learningAgenda',\n  'Primary Reporting KPI': 'primaryReportingKpi',\n  'Demo': 'demo',\n  'Tactic': 'tactic',\n};\n\n/**\n * Traffic sheet column mappings by tab\n * Maps internal field names to traffic sheet column names\n */\nexport const TRAFFIC_SHEET_FIELD_MAPPINGS: Record<TrafficSheetTab, Record<string, string>> = {\n  'Brand Say Digital': {\n    // Campaign-level fields\n    'platform': 'Platform',\n    'startDate': 'Start Date',\n    'endDate': 'End Date',\n    'objective': 'Objective',\n    'language': 'Language',\n    'buyType': 'Buy Type',\n    'demo': 'Demo',\n    'placements': 'Tactic',  // Placements ‚Üí Tactic for digital\n    'accuticsCampaignName': 'Accutics Campaign Name',\n    'creativetype': 'Creative Type',  // Left blank for client\n    'device': 'Device',  // Left blank for client\n    'geo': 'Geo',  // Left blank for client\n\n    // Ad group-level fields\n    'audience': 'Audience',\n    'accuticsAdSetName': 'Accutics Ad Set Name',\n    'kpi': 'KPI Metric',\n    'bidType': 'Bid Type',  // Ad group level - \"Lowest Cost\"\n    'optimizationEvent': 'Optimization Event',  // Creative level - blank\n\n    // Creative-level fields (blank for creative agency)\n    'creativeName': 'Creative Name',\n    'linkToCreative': 'Link to Creative',\n    'postCopy': 'Post Copy',\n    'headline': 'Headline',\n  },\n\n  'Brand Say Social': {\n    // Campaign-level fields\n    'platform': 'Platform',\n    'startDate': 'Start Date',\n    'endDate': 'End Date',\n    'objective': 'Objective',\n    'language': 'Language',\n    'buyType': 'Buy Type',\n    'placements': 'Campaign Name (Taxonomy from Accuitics)',  // Placements ‚Üí Campaign Name for social\n    'traffickingNotes': 'Trafficking Notes',\n\n    // Ad group-level fields\n    'audience': 'Audience',\n    'adSetName': 'Ad Set Name (Taxonomy from Accuitics)',\n    'targetingSummary': 'Targeting Summary',  // Left blank for client\n    'adGroupPlacements': 'Placements',  // Ad group-level placements\n    'bidType': 'Bid Type',  // Ad group level - \"Lowest Cost\"\n    'optimizationEvent': 'Optimization Event',  // Creative level - blank\n\n    // Creative-level fields (blank for creative agency)\n    'creativeName': 'Creative Name',\n    'linkToCreative': 'Link to Creative',\n    'postCopy': 'Post Copy',\n    'headline': 'Headline',\n    'primaryText': 'Primary Text',\n  },\n\n  'Other Say Social': {\n    // Campaign-level fields\n    'platform': 'Platform',\n    'startDate': 'Start Date',\n    'endDate': 'End Date',\n    'objective': 'Objective',\n    'language': 'Language',\n    'buyType': 'Buy Type',\n    'placements': 'Campaign Name (Taxonomy from Accuitics)',\n    'traffickingNotes': 'Trafficking Notes',\n\n    // Ad group-level fields\n    'audience': 'Audience',\n    'adSetName': 'Ad Set Name (Taxonomy from Accuitics)',\n    'targetingSummary': 'Targeting Summary',\n    'adGroupPlacements': 'Placements',  // Ad group-level placements\n    'bidType': 'Bid Type',  // Ad group level - \"Lowest Cost\"\n    'optimizationEvent': 'Optimization Event',  // Creative level - blank\n\n    // Creative-level fields\n    'creativeName': 'Creative Name',\n    'linkToCreative': 'Link to Creative',\n    'postCopy': 'Post Copy',\n    'headline': 'Headline',\n  },\n};\n\n/**\n * Get internal field name from blocking chart column name\n *\n * @param blockingChartColumn - Column name from blocking chart\n * @returns Internal field name or undefined if not found\n */\nexport function getInternalFieldName(blockingChartColumn: string): string | undefined {\n  // Try direct mapping first\n  if (BLOCKING_CHART_FIELD_MAPPINGS[blockingChartColumn]) {\n    return BLOCKING_CHART_FIELD_MAPPINGS[blockingChartColumn];\n  }\n\n  // Try normalized lookup\n  const normalized = normalizeFieldName(blockingChartColumn);\n  for (const [key, value] of Object.entries(BLOCKING_CHART_FIELD_MAPPINGS)) {\n    if (normalizeFieldName(key) === normalized) {\n      return value;\n    }\n  }\n\n  return undefined;\n}\n\n/**\n * Get traffic sheet column name from internal field name\n *\n * @param internalFieldName - Internal field name\n * @param tab - Traffic sheet tab\n * @returns Traffic sheet column name or undefined if not found\n */\nexport function getTrafficSheetColumnName(\n  internalFieldName: string,\n  tab: TrafficSheetTab\n): string | undefined {\n  return TRAFFIC_SHEET_FIELD_MAPPINGS[tab][internalFieldName];\n}\n\n/**\n * Build a map of traffic sheet column names to column indexes\n * Used for efficient column lookup during sheet writing\n *\n * @param headers - Array of column header names from traffic sheet template\n * @returns Map of normalized column name ‚Üí column index\n */\nexport function buildColumnIndexMap(headers: string[]): Map<string, number> {\n  const map = new Map<string, number>();\n\n  headers.forEach((header, index) => {\n    if (header) {\n      // Store both normalized and original for flexible lookup\n      map.set(normalizeFieldName(header), index);\n      map.set(header, index);\n    }\n  });\n\n  return map;\n}\n\n/**\n * Map blocking chart data to internal structure\n *\n * @param blockingChartRow - Raw row data from blocking chart\n * @param headers - Blocking chart column headers\n * @returns Object with internal field names as keys\n */\nexport function mapBlockingChartRowToInternal(\n  blockingChartRow: Record<string, any>,\n  headers: string[]\n): Record<string, any> {\n  const mapped: Record<string, any> = {};\n\n  headers.forEach((header, index) => {\n    const internalField = getInternalFieldName(header);\n    if (internalField && blockingChartRow[header] !== undefined) {\n      mapped[internalField] = blockingChartRow[header];\n    }\n  });\n\n  return mapped;\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 875, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/trafficSheetWriter.ts"],"sourcesContent":["/**\n * Traffic Sheet Generator\n * Generates Excel traffic sheets from parsed blocking chart data\n * Handles categorization, merging, and formatting for all three tabs\n */\n\nimport * as ExcelJS from 'exceljs';\nimport type {\n  ParsedBlockingChart,\n  CampaignLine,\n  AdGroup,\n  TrafficSheetTab,\n  CategorizedCampaignLines,\n  MergeInfo,\n} from './types';\nimport { TRAFFIC_SHEET_CONFIG, ROW_EXPANSION_CONFIG, DEMOGRAPHIC_CONFIG, DATE_CONFIG } from './config';\nimport {\n  getTrafficSheetTab,\n  getDefaultPlacements,\n} from './utils/PlatformClassifier';\nimport {\n  TRAFFIC_SHEET_FIELD_MAPPINGS,\n  buildColumnIndexMap,\n} from './utils/FieldMapper';\nimport { normalizeFieldName } from './utils/FieldNormalizer';\n\n/**\n * Traffic Sheet Generator Class\n * Converts parsed campaign lines into formatted Excel traffic sheets\n */\nexport class TrafficSheetGenerator {\n  /**\n   * Generate traffic sheet Excel workbook from parsed blocking chart\n   *\n   * @param parsedChart - Parsed blocking chart data\n   * @param templateBuffer - Optional template file as ArrayBuffer\n   * @returns Excel workbook with traffic sheets\n   */\n  async generate(\n    parsedChart: ParsedBlockingChart,\n    templateBuffer?: ArrayBuffer\n  ): Promise<ExcelJS.Workbook> {\n    // Create or load workbook\n    let workbook: ExcelJS.Workbook;\n\n    if (templateBuffer) {\n      // Load template workbook\n      console.log('üìÑ Loading template workbook...');\n      workbook = new ExcelJS.Workbook();\n      await workbook.xlsx.load(templateBuffer);\n      console.log('‚úÖ Template loaded successfully');\n\n      // Clear existing data rows (keep headers and formatting)\n      await this.clearTemplateData(workbook);\n    } else {\n      // Create workbook from scratch (fallback)\n      console.log('üìÑ Creating workbook from scratch (no template provided)');\n      workbook = new ExcelJS.Workbook();\n      await this.createWorkbookFromScratch(workbook);\n    }\n\n    // Categorize campaign lines by tab\n    const categorized = this.categorizeCampaignLines(parsedChart.campaignLines);\n\n    console.log(`üìä Categorization Results:`);\n    console.log(`  Brand Say Digital: ${categorized['Brand Say Digital'].length} lines`);\n    console.log(`  Brand Say Social: ${categorized['Brand Say Social'].length} lines`);\n    console.log(`  Other Say Social: ${categorized['Other Say Social'].length} lines`);\n\n    // Write each tab\n    await this.writeTab(workbook, 'Brand Say Digital', categorized['Brand Say Digital']);\n    await this.writeTab(workbook, 'Brand Say Social', categorized['Brand Say Social']);\n    await this.writeTab(workbook, 'Other Say Social', categorized['Other Say Social']);\n\n    return workbook;\n  }\n\n  /**\n   * Clear template data rows while preserving headers and formatting\n   */\n  private async clearTemplateData(workbook: ExcelJS.Workbook): Promise<void> {\n    const tabs: TrafficSheetTab[] = ['Brand Say Digital', 'Brand Say Social', 'Other Say Social'];\n\n    for (const tabName of tabs) {\n      const worksheet = workbook.getWorksheet(tabName);\n      if (!worksheet) {\n        console.warn(`‚ö†Ô∏è  Template missing worksheet: ${tabName}`);\n        continue;\n      }\n\n      // Delete all rows after the header row (row 8)\n      const firstDataRow = TRAFFIC_SHEET_CONFIG.FIRST_DATA_ROW;\n      const lastRow = worksheet.rowCount;\n\n      if (lastRow >= firstDataRow) {\n        // Delete rows in reverse order to avoid index shifting\n        for (let rowNum = lastRow; rowNum >= firstDataRow; rowNum--) {\n          worksheet.spliceRows(rowNum, 1);\n        }\n        console.log(`  üßπ Cleared ${lastRow - firstDataRow + 1} data rows from ${tabName}`);\n      }\n    }\n  }\n\n  /**\n   * Create workbook structure from scratch\n   * Creates three worksheets with basic headers\n   */\n  private async createWorkbookFromScratch(workbook: ExcelJS.Workbook): Promise<void> {\n    // Create three worksheets\n    const bsdSheet = workbook.addWorksheet('Brand Say Digital');\n    const bssSheet = workbook.addWorksheet('Brand Say Social');\n    const ossSheet = workbook.addWorksheet('Other Say Social');\n\n    // Set up basic headers (row 8)\n    this.setupWorksheetHeaders(bsdSheet, 'Brand Say Digital');\n    this.setupWorksheetHeaders(bssSheet, 'Brand Say Social');\n    this.setupWorksheetHeaders(ossSheet, 'Other Say Social');\n  }\n\n  /**\n   * Set up worksheet headers\n   */\n  private setupWorksheetHeaders(worksheet: ExcelJS.Worksheet, tab: TrafficSheetTab): void {\n    const headerRow = worksheet.getRow(TRAFFIC_SHEET_CONFIG.HEADER_LABEL_ROW);\n\n    // Get field mappings for this tab\n    const fieldMappings = TRAFFIC_SHEET_FIELD_MAPPINGS[tab];\n\n    // Write headers\n    let col = 1;\n    for (const [internalName, displayName] of Object.entries(fieldMappings)) {\n      headerRow.getCell(col).value = displayName;\n      col++;\n    }\n\n    headerRow.commit();\n  }\n\n  /**\n   * Categorize campaign lines by traffic sheet tab\n   */\n  private categorizeCampaignLines(\n    campaignLines: CampaignLine[]\n  ): CategorizedCampaignLines {\n    const categorized: CategorizedCampaignLines = {\n      'Brand Say Digital': [],\n      'Brand Say Social': [],\n      'Other Say Social': [],\n    };\n\n    for (const campaignLine of campaignLines) {\n      // Skip excluded channels (OOH, TV, Radio, Print)\n      if (campaignLine.isExcluded) {\n        console.log(`‚è≠Ô∏è  Skipping excluded campaign line: ${campaignLine.platform} / ${campaignLine.channel}`);\n        continue;\n      }\n\n      // Determine which tab this campaign line belongs to\n      const tab = getTrafficSheetTab(campaignLine.platform, campaignLine.channel, campaignLine.adFormat);\n      console.log(`üìÇ Categorizing: Platform=\"${campaignLine.platform}\" Channel=\"${campaignLine.channel}\" AdFormat=\"${campaignLine.adFormat}\" ‚Üí Tab=\"${tab}\"`);\n      categorized[tab].push(campaignLine);\n    }\n\n    return categorized;\n  }\n\n  /**\n   * Write campaign lines to a worksheet tab\n   */\n  private async writeTab(\n    workbook: ExcelJS.Workbook,\n    tabName: TrafficSheetTab,\n    campaignLines: CampaignLine[]\n  ): Promise<void> {\n    const worksheet = workbook.getWorksheet(tabName);\n    if (!worksheet) {\n      throw new Error(`Worksheet ${tabName} not found`);\n    }\n\n    // Get headers from row 8\n    const headerRow = worksheet.getRow(TRAFFIC_SHEET_CONFIG.HEADER_LABEL_ROW);\n    const headers: string[] = [];\n    headerRow.eachCell((cell, colNumber) => {\n      headers[colNumber - 1] = String(cell.value || '');\n    });\n\n    // Build column index map for fast lookup\n    const columnMap = buildColumnIndexMap(headers);\n\n    // Track current row position\n    let currentRow = TRAFFIC_SHEET_CONFIG.FIRST_DATA_ROW;\n\n    // Track all merges to apply at the end\n    const allMerges: MergeInfo[] = [];\n\n    // Write each campaign line\n    for (const campaignLine of campaignLines) {\n      const merges = this.writeCampaignLine(\n        worksheet,\n        campaignLine,\n        currentRow,\n        tabName,\n        columnMap\n      );\n\n      allMerges.push(...merges);\n\n      // Calculate total rows for this campaign line\n      const totalRows = campaignLine.adGroups.length * ROW_EXPANSION_CONFIG.CREATIVES_PER_AD_GROUP;\n      currentRow += totalRows;\n    }\n\n    // Apply all merges\n    this.applyMerges(worksheet, allMerges);\n\n    // Apply borders\n    this.applyBorders(worksheet, tabName, currentRow - 1);\n\n    // Apply cell alignment (center horizontal, middle vertical)\n    this.applyCellAlignment(worksheet, currentRow - 1);\n\n    // Auto-size columns and rows\n    this.autoSizeColumnsAndRows(worksheet, currentRow - 1);\n  }\n\n  /**\n   * Write a single campaign line to worksheet\n   * Returns merge information for later application\n   */\n  private writeCampaignLine(\n    worksheet: ExcelJS.Worksheet,\n    campaignLine: CampaignLine,\n    startRow: number,\n    tab: TrafficSheetTab,\n    columnMap: Map<string, number>\n  ): MergeInfo[] {\n    const merges: MergeInfo[] = [];\n    const totalRows = campaignLine.adGroups.length * ROW_EXPANSION_CONFIG.CREATIVES_PER_AD_GROUP;\n    const endRow = startRow + totalRows - 1;\n\n    // Write campaign-level fields (merge across all rows)\n    const campaignFields = this.getCampaignLevelFields(campaignLine, tab);\n    for (const [fieldName, value] of Object.entries(campaignFields)) {\n      const colIndex = this.getColumnIndex(columnMap, fieldName, tab);\n      if (colIndex !== undefined) {\n        // Write to first row\n        const firstRow = worksheet.getRow(startRow);\n        firstRow.getCell(colIndex + 1).value = value;\n\n        // Add merge if more than 1 row\n        if (totalRows > 1) {\n          merges.push({\n            startRow,\n            endRow,\n            startCol: colIndex + 1,\n            endCol: colIndex + 1,\n          });\n        }\n      }\n    }\n\n    // Write ad groups\n    let currentRow = startRow;\n    for (const adGroup of campaignLine.adGroups) {\n      const adGroupMerges = this.writeAdGroup(\n        worksheet,\n        adGroup,\n        campaignLine,\n        currentRow,\n        tab,\n        columnMap\n      );\n\n      merges.push(...adGroupMerges);\n      currentRow += ROW_EXPANSION_CONFIG.CREATIVES_PER_AD_GROUP;\n    }\n\n    return merges;\n  }\n\n  /**\n   * Write a single ad group (5 creative lines)\n   */\n  private writeAdGroup(\n    worksheet: ExcelJS.Worksheet,\n    adGroup: AdGroup,\n    campaignLine: CampaignLine,\n    startRow: number,\n    tab: TrafficSheetTab,\n    columnMap: Map<string, number>\n  ): MergeInfo[] {\n    const merges: MergeInfo[] = [];\n    const endRow = startRow + ROW_EXPANSION_CONFIG.CREATIVES_PER_AD_GROUP - 1;\n\n    // Write ad group-level fields (merge across 5 rows)\n    const adGroupFields = this.getAdGroupLevelFields(adGroup, campaignLine, tab);\n    for (const [fieldName, value] of Object.entries(adGroupFields)) {\n      const colIndex = this.getColumnIndex(columnMap, fieldName, tab);\n      if (colIndex !== undefined) {\n        // Write to first row\n        const firstRow = worksheet.getRow(startRow);\n        firstRow.getCell(colIndex + 1).value = value;\n\n        // Add merge for 5 rows\n        merges.push({\n          startRow,\n          endRow,\n          startCol: colIndex + 1,\n          endCol: colIndex + 1,\n        });\n      }\n    }\n\n    // Write creative lines (no merging)\n    for (let i = 0; i < ROW_EXPANSION_CONFIG.CREATIVES_PER_AD_GROUP; i++) {\n      const creative = adGroup.creativeLines[i];\n      const rowNumber = startRow + i;\n\n      const creativeFields = this.getCreativeLevelFields(creative);\n      for (const [fieldName, value] of Object.entries(creativeFields)) {\n        const colIndex = this.getColumnIndex(columnMap, fieldName, tab);\n        if (colIndex !== undefined) {\n          const row = worksheet.getRow(rowNumber);\n          row.getCell(colIndex + 1).value = value;\n        }\n      }\n    }\n\n    return merges;\n  }\n\n  /**\n   * Get campaign-level field values\n   */\n  private getCampaignLevelFields(\n    campaignLine: CampaignLine,\n    tab: TrafficSheetTab\n  ): Record<string, any> {\n    // Determine buy type based on platform and placements\n    // Default is 'Auction' for all tactics, merged at campaign level\n    // Exception: 'Reach & Frequency' only for TikTok Pulse placements\n    let buyType = 'Auction';\n\n    // Check if this is a TikTok Pulse buy\n    const isTikTok = campaignLine.platform?.toLowerCase().includes('tiktok') ||\n                     campaignLine.platform?.toLowerCase().includes('tik tok');\n    const isPulse = campaignLine.placements?.toLowerCase().includes('pulse') ||\n                    campaignLine.adGroups.some(ag => ag.placements?.toLowerCase().includes('pulse'));\n\n    if (isTikTok && isPulse) {\n      buyType = 'Reach & Frequency';\n    }\n    // Note: Do not use buyType from blocking chart - always use 'Auction' except for TikTok Pulse\n\n    const fields: Record<string, any> = {\n      platform: campaignLine.platform,\n      startDate: this.formatDateForTrafficSheet(campaignLine.startDate),\n      endDate: this.formatDateForTrafficSheet(campaignLine.endDate),\n      objective: campaignLine.objective,\n      language: campaignLine.language,\n      buyType: buyType,\n    };\n\n    // Tab-specific fields\n    if (tab === 'Brand Say Digital') {\n      fields.demo = this.extractDemographic(campaignLine.target);\n      fields.placements = campaignLine.placements; // Maps to \"Tactic\" column\n      fields.accuticsCampaignName = campaignLine.accuticsCampaignName;\n    } else {\n      // Social tabs\n      fields.placements = campaignLine.accuticsCampaignName; // Maps to \"Campaign Name (Taxonomy from Accuitics)\"\n\n      // Platform-specific placements (campaign level - merged by platform across ad groups)\n      fields.adGroupPlacements = getDefaultPlacements(\n        campaignLine.platform,\n        campaignLine.adGroups[0]?.placements || ''\n      );\n\n      // Build trafficking notes\n      const notes: string[] = [];\n      if (campaignLine.tagsRequired) {\n        notes.push(`Tags Required: ${campaignLine.tagsRequired}`);\n      }\n      if (campaignLine.adGroups[0]?.measurement) {\n        notes.push(`Measurement: ${campaignLine.adGroups[0].measurement}`);\n      }\n      fields.traffickingNotes = notes.join('\\n');\n    }\n\n    return fields;\n  }\n\n  /**\n   * Get ad group-level field values\n   */\n  private getAdGroupLevelFields(\n    adGroup: AdGroup,\n    campaignLine: CampaignLine,\n    tab: TrafficSheetTab\n  ): Record<string, any> {\n    const fields: Record<string, any> = {\n      audience: adGroup.audience,\n      kpi: adGroup.kpi,\n      bidType: 'Lowest Cost', // Bid Type - always 'Lowest Cost' for all tabs\n    };\n\n    // Tab-specific fields\n    if (tab === 'Brand Say Digital') {\n      fields.accuticsAdSetName = adGroup.accuticsCampaignName;\n    } else {\n      // Social tabs\n      fields.adSetName = adGroup.accuticsCampaignName;\n    }\n\n    return fields;\n  }\n\n  /**\n   * Get creative-level field values\n   */\n  private getCreativeLevelFields(creative: any): Record<string, any> {\n    // Creative fields are typically left blank for creative agency to fill\n    return {\n      creativeName: creative.creativeName || '',\n      linkToCreative: '',\n      postCopy: '',\n      headline: '',\n      optimizationEvent: '', // Optimization Event - left blank\n    };\n  }\n\n  /**\n   * Format date from blocking chart to traffic sheet format\n   * Example: \"2025-01-05\" ‚Üí \"5-Jan-25\"\n   * Parses the date string directly to avoid timezone conversion issues\n   */\n  private formatDateForTrafficSheet(dateString: string): string {\n    if (!dateString) return '';\n\n    try {\n      // Parse YYYY-MM-DD format directly without creating a Date object\n      const parts = dateString.split('-');\n      if (parts.length !== 3) return dateString;\n\n      const year = parts[0];\n      const monthIndex = parseInt(parts[1], 10) - 1;\n      const day = parseInt(parts[2], 10);\n\n      const monthName = DATE_CONFIG.MONTH_NAMES[monthIndex] || '';\n      const yearShort = year.slice(-2);\n\n      return `${day}-${monthName}-${yearShort}`;\n    } catch (error) {\n      return dateString; // Return original if parsing fails\n    }\n  }\n\n  /**\n   * Extract demographic code from target field\n   * Example: \"W25-49\" from \"Women 25-49 years old\"\n   */\n  private extractDemographic(target?: string): string {\n    if (!target) return DEMOGRAPHIC_CONFIG.DEFAULT_DEMO;\n\n    const match = target.match(DEMOGRAPHIC_CONFIG.DEMO_PATTERN);\n    if (match) {\n      return match[0]; // Return first match (e.g., \"W25-49\")\n    }\n\n    return DEMOGRAPHIC_CONFIG.DEFAULT_DEMO;\n  }\n\n  /**\n   * Get column index from map (try multiple variations)\n   */\n  private getColumnIndex(columnMap: Map<string, number>, fieldName: string, tab: TrafficSheetTab): number | undefined {\n    // First, map the internal field name to the traffic sheet column name\n    const fieldMappings = TRAFFIC_SHEET_FIELD_MAPPINGS[tab];\n    const targetColumnName = fieldMappings[fieldName] || fieldName;\n\n    // Try exact match first\n    if (columnMap.has(targetColumnName)) {\n      return columnMap.get(targetColumnName);\n    }\n\n    // Try normalized match\n    const normalized = normalizeFieldName(targetColumnName);\n    return columnMap.get(normalized);\n  }\n\n  /**\n   * Apply all merge operations to worksheet\n   */\n  private applyMerges(worksheet: ExcelJS.Worksheet, merges: MergeInfo[]): void {\n    for (const merge of merges) {\n      try {\n        worksheet.mergeCells(\n          merge.startRow,\n          merge.startCol,\n          merge.endRow,\n          merge.endCol\n        );\n      } catch (error) {\n        // Merge may already exist or be invalid, skip\n        console.warn(`Failed to merge cells: ${error.message}`);\n      }\n    }\n  }\n\n  /**\n   * Apply borders to data region\n   */\n  private applyBorders(\n    worksheet: ExcelJS.Worksheet,\n    tab: TrafficSheetTab,\n    lastRow: number\n  ): void {\n    const borderConfig = TRAFFIC_SHEET_CONFIG.BORDER_CONFIG[tab];\n    if (!borderConfig) return;\n\n    const borderStyle = {\n      style: 'thin' as const,\n      color: { argb: 'FF000000' },\n    };\n\n    // Apply borders to data region\n    for (let row = TRAFFIC_SHEET_CONFIG.FIRST_DATA_ROW; row <= lastRow; row++) {\n      for (let col = borderConfig.start; col <= borderConfig.end; col++) {\n        const cell = worksheet.getRow(row).getCell(col);\n        cell.border = {\n          top: borderStyle,\n          left: borderStyle,\n          bottom: borderStyle,\n          right: borderStyle,\n        };\n      }\n    }\n  }\n\n  /**\n   * Apply center horizontal and middle vertical alignment to all cells\n   */\n  private applyCellAlignment(\n    worksheet: ExcelJS.Worksheet,\n    lastRow: number\n  ): void {\n    // Apply alignment to all data rows (starting from first data row)\n    for (let rowNum = TRAFFIC_SHEET_CONFIG.FIRST_DATA_ROW; rowNum <= lastRow; rowNum++) {\n      const row = worksheet.getRow(rowNum);\n      row.eachCell((cell) => {\n        cell.alignment = {\n          horizontal: 'center',\n          vertical: 'middle',\n          wrapText: true, // Enable text wrapping for better visibility\n        };\n      });\n    }\n\n    // Also apply alignment to header row\n    const headerRow = worksheet.getRow(TRAFFIC_SHEET_CONFIG.HEADER_LABEL_ROW);\n    headerRow.eachCell((cell) => {\n      cell.alignment = {\n        horizontal: 'center',\n        vertical: 'middle',\n        wrapText: true,\n      };\n    });\n  }\n\n  /**\n   * Auto-size columns and rows to fit content\n   */\n  private autoSizeColumnsAndRows(\n    worksheet: ExcelJS.Worksheet,\n    lastRow: number\n  ): void {\n    // Auto-size columns based on content\n    worksheet.columns.forEach((column, index) => {\n      if (!column) return;\n\n      let maxLength = 0;\n      const columnNumber = index + 1;\n\n      // Check header row\n      const headerCell = worksheet.getRow(TRAFFIC_SHEET_CONFIG.HEADER_LABEL_ROW).getCell(columnNumber);\n      if (headerCell.value) {\n        maxLength = String(headerCell.value).length;\n      }\n\n      // Check all data rows\n      for (let rowNum = TRAFFIC_SHEET_CONFIG.FIRST_DATA_ROW; rowNum <= lastRow; rowNum++) {\n        const cell = worksheet.getRow(rowNum).getCell(columnNumber);\n        if (cell.value) {\n          const cellLength = String(cell.value).length;\n          if (cellLength > maxLength) {\n            maxLength = cellLength;\n          }\n        }\n      }\n\n      // Set column width with some padding (minimum 10, maximum 50)\n      column.width = Math.min(Math.max(maxLength + 2, 10), 50);\n    });\n\n    // Auto-size rows (set minimum height for better visibility)\n    for (let rowNum = TRAFFIC_SHEET_CONFIG.FIRST_DATA_ROW; rowNum <= lastRow; rowNum++) {\n      const row = worksheet.getRow(rowNum);\n      // Set minimum row height to 20 for better visibility\n      row.height = Math.max(row.height || 0, 20);\n    }\n\n    // Set header row height\n    const headerRow = worksheet.getRow(TRAFFIC_SHEET_CONFIG.HEADER_LABEL_ROW);\n    headerRow.height = Math.max(headerRow.height || 0, 25);\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1330, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/parser/BlockingChartParser.ts"],"sourcesContent":["/**\n * Blocking Chart Parser\n * Parses Excel blocking charts and builds hierarchical campaign line structure\n * with dynamic ad group detection based on audience values\n */\n\nimport * as ExcelJS from 'exceljs';\nimport type {\n  ParsedBlockingChart,\n  CampaignLine,\n  AdGroup,\n  CreativeLine,\n  ValidationWarning,\n  CampaignLineRange,\n} from '../types';\nimport {\n  PARSING_CONFIG,\n  CAMPAIGN_LINE_DETECTION_CONFIG,\n  AD_GROUP_DETECTION_CONFIG,\n  ROW_EXPANSION_CONFIG,\n} from '../config';\nimport {\n  BLOCKING_CHART_FIELD_MAPPINGS,\n  getInternalFieldName,\n  CAMPAIGN_LINE_INDICATORS,\n} from '../utils/FieldMapper';\nimport { normalizeFieldName } from '../utils/FieldNormalizer';\nimport { isExcludedChannel, getExclusionReason } from '../utils/PlatformClassifier';\n\n/**\n * Blocking Chart Parser Class\n * Converts Excel blocking chart into structured campaign line data\n */\nexport class BlockingChartParser {\n  private validationWarnings: ValidationWarning[] = [];\n\n  /**\n   * Parse blocking chart Excel file into structured campaign lines\n   *\n   * @param fileBuffer - ArrayBuffer containing the Excel file data\n   * @returns Parsed blocking chart with hierarchical campaign line structure\n   */\n  async parse(fileBuffer: ArrayBuffer): Promise<ParsedBlockingChart> {\n    this.validationWarnings = [];\n\n    // Load workbook\n    const workbook = new ExcelJS.Workbook();\n    await workbook.xlsx.load(fileBuffer);\n\n    // Get first worksheet\n    const worksheet = workbook.worksheets[0];\n    if (!worksheet) {\n      throw new Error('No worksheets found in blocking chart');\n    }\n\n    // Find header row and extract headers\n    const { headerRow, headers } = this.findHeaderRow(worksheet);\n    if (!headerRow || headers.length === 0) {\n      throw new Error('Could not find header row in blocking chart');\n    }\n\n    // Extract metadata from rows above header\n    const metadata = this.extractMetadata(worksheet, headerRow);\n\n    // Detect campaign lines by finding merged cells\n    const campaignLineRanges = this.detectCampaignLines(worksheet, headerRow, headers);\n\n    if (campaignLineRanges.length === 0) {\n      this.addWarning('warning', 'No campaign lines detected in blocking chart', undefined, undefined);\n    }\n\n    // Build campaign lines with audience-based ad group detection\n    const campaignLines = this.buildCampaignLines(\n      worksheet,\n      headers,\n      campaignLineRanges,\n      headerRow\n    );\n\n    return {\n      headers,\n      campaignLines,\n      validationWarnings: this.validationWarnings,\n      metadata,\n    };\n  }\n\n  /**\n   * Find header row in worksheet\n   * Header row contains column names like \"Channel\", \"Platform\", etc.\n   */\n  private findHeaderRow(worksheet: ExcelJS.Worksheet): {\n    headerRow: number;\n    headers: string[];\n  } {\n    const maxRows = Math.min(worksheet.rowCount, PARSING_CONFIG.MAX_METADATA_ROWS + 5);\n\n    for (let rowNumber = 1; rowNumber <= maxRows; rowNumber++) {\n      const row = worksheet.getRow(rowNumber);\n      const values: string[] = [];\n      let nonEmptyCount = 0;\n\n      row.eachCell({ includeEmpty: false }, (cell, colNumber) => {\n        const value = String(cell.value || '').trim();\n        values[colNumber - 1] = value;\n        if (value) nonEmptyCount++;\n      });\n\n      // Check if this row has enough non-empty cells and contains required keywords\n      if (nonEmptyCount >= PARSING_CONFIG.MIN_HEADER_CELLS) {\n        const normalizedValues = values.map(v => normalizeFieldName(v));\n        const hasRequiredKeywords = PARSING_CONFIG.REQUIRED_HEADER_KEYWORDS.every(keyword =>\n          normalizedValues.some(v => v.includes(keyword))\n        );\n\n        if (hasRequiredKeywords) {\n          return { headerRow: rowNumber, headers: values };\n        }\n      }\n    }\n\n    throw new Error('Header row not found in blocking chart');\n  }\n\n  /**\n   * Extract metadata from rows above header (campaign name, client, etc.)\n   */\n  private extractMetadata(\n    worksheet: ExcelJS.Worksheet,\n    headerRow: number\n  ): ParsedBlockingChart['metadata'] {\n    const metadata: ParsedBlockingChart['metadata'] = {};\n\n    // Scan rows above header for metadata\n    for (let rowNumber = 1; rowNumber < headerRow; rowNumber++) {\n      const row = worksheet.getRow(rowNumber);\n      const firstCell = row.getCell(1).value;\n      const secondCell = row.getCell(2).value;\n\n      const label = String(firstCell || '').toLowerCase().trim();\n      const value = String(secondCell || '').trim();\n\n      if (label.includes('campaign') && value) {\n        metadata.campaignName = value;\n      } else if (label.includes('client') && value) {\n        metadata.client = value;\n      } else if (label.includes('brand') && value) {\n        metadata.brand = value;\n      } else if (label.includes('date') && value) {\n        metadata.dateRange = value;\n      }\n    }\n\n    return metadata;\n  }\n\n  /**\n   * Detect campaign lines by finding merged cells across budget, impressions, and placements columns\n   * A campaign line is identified when these three columns are merged together\n   */\n  private detectCampaignLines(\n    worksheet: ExcelJS.Worksheet,\n    headerRow: number,\n    headers: string[]\n  ): CampaignLineRange[] {\n    // Find column indexes for the three required merge indicators\n    const budgetColIndex = this.findColumnIndex(headers, ['Gross Budget', 'Net Budget', 'Media Cost', 'Working Media Budget']);\n    const impressionsColIndex = this.findColumnIndex(headers, ['Est. Impressions', 'Impressions/GRPs', 'Impressions']);\n    const placementsColIndex = this.findColumnIndex(headers, ['Campaign Details - Placements', 'Placements']);\n\n    console.log('üîç Column Detection:');\n    console.log('  Budget column index:', budgetColIndex);\n    console.log('  Impressions column index:', impressionsColIndex);\n    console.log('  Placements column index:', placementsColIndex);\n    console.log('  Available headers:', headers.filter(h => h));\n\n    if (budgetColIndex === -1 || impressionsColIndex === -1 || placementsColIndex === -1) {\n      this.addWarning(\n        'error',\n        `Required columns not found - Budget: ${budgetColIndex}, Impressions: ${impressionsColIndex}, Placements: ${placementsColIndex}`,\n        undefined,\n        undefined\n      );\n      return [];\n    }\n\n    // Collect all merge ranges for these columns\n    const budgetMerges = new Map<number, number>(); // masterRow ‚Üí span\n    const impressionsMerges = new Map<number, number>();\n    const placementsMerges = new Map<number, number>();\n\n    // Helper function to get column letter from index\n    const getColumnLetter = (index: number): string => {\n      let letter = '';\n      let temp = index;\n      while (temp >= 0) {\n        letter = String.fromCharCode(65 + (temp % 26)) + letter;\n        temp = Math.floor(temp / 26) - 1;\n      }\n      return letter;\n    };\n\n    // ExcelJS exposes merged cells through worksheet.model.merges\n    // Merges are stored as strings like \"A1:A5\"\n    const merges = (worksheet as any).model?.merges || [];\n    console.log(`üìã Total merge cells found: ${merges.length}`);\n\n    for (const mergeRange of merges) {\n      // Parse merge range (e.g., \"A1:A5\")\n      const match = mergeRange.match(/([A-Z]+)(\\d+):([A-Z]+)(\\d+)/);\n      if (!match) continue;\n\n      const startCol = match[1];\n      const startRow = parseInt(match[2]);\n      const endCol = match[3];\n      const endRow = parseInt(match[4]);\n      const span = endRow - startRow + 1;\n\n      // Skip if merge is in header or only 1 row\n      if (startRow <= headerRow || span <= 1) continue;\n\n      // Check if this merge is in one of our target columns\n      const budgetCol = getColumnLetter(budgetColIndex);\n      const impressionsCol = getColumnLetter(impressionsColIndex);\n      const placementsCol = getColumnLetter(placementsColIndex);\n\n      if (startCol === budgetCol && endCol === budgetCol) {\n        budgetMerges.set(startRow, span);\n      }\n\n      if (startCol === impressionsCol && endCol === impressionsCol) {\n        impressionsMerges.set(startRow, span);\n      }\n\n      if (startCol === placementsCol && endCol === placementsCol) {\n        placementsMerges.set(startRow, span);\n      }\n    }\n\n    // Find matching merges (all three columns merged with same span at same master row)\n    const campaignLineRanges: CampaignLineRange[] = [];\n\n    console.log(`üîó Budget merges found: ${budgetMerges.size}`);\n    console.log('   Budget merge rows:', Array.from(budgetMerges.keys()));\n    console.log(`üîó Impressions merges found: ${impressionsMerges.size}`);\n    console.log('   Impressions merge rows:', Array.from(impressionsMerges.keys()));\n    console.log(`üîó Placements merges found: ${placementsMerges.size}`);\n    console.log('   Placements merge rows:', Array.from(placementsMerges.keys()));\n\n    // Strategy 1: Find triple-merged campaign lines (2+ ad groups)\n    for (const [masterRow, budgetSpan] of budgetMerges.entries()) {\n      const impressionsSpan = impressionsMerges.get(masterRow);\n      const placementsSpan = placementsMerges.get(masterRow);\n\n      // All three must match to be a valid campaign line\n      if (impressionsSpan === budgetSpan && placementsSpan === budgetSpan) {\n        // Verify this is not a summary/total row\n        if (!this.isSummaryRow(worksheet, masterRow, headers)) {\n          campaignLineRanges.push({\n            masterRow,\n            span: budgetSpan,\n            endRow: masterRow + budgetSpan - 1,\n          });\n        }\n      }\n    }\n\n    // Strategy 2: Find single-row campaign lines (1 ad group - no merges)\n    // Look for data rows that have budget, impressions, and placements filled but not merged\n    const detectedRows = new Set(campaignLineRanges.flatMap(r =>\n      Array.from({ length: r.span }, (_, i) => r.masterRow + i)\n    ));\n\n    const lastDataRow = Math.min(worksheet.rowCount, headerRow + 100);\n    console.log(`üîç Scanning rows ${headerRow + 1} to ${lastDataRow} for single-row campaign lines...`);\n\n    for (let rowNum = headerRow + 1; rowNum <= lastDataRow; rowNum++) {\n      // Skip if already detected as part of a merged campaign line\n      if (detectedRows.has(rowNum)) continue;\n\n      const row = worksheet.getRow(rowNum);\n      const budgetValue = row.getCell(budgetColIndex + 1).value;\n      const impressionsValue = row.getCell(impressionsColIndex + 1).value;\n      const placementsValue = row.getCell(placementsColIndex + 1).value;\n\n      // Check if this row has all three key values filled\n      if (budgetValue && impressionsValue && placementsValue) {\n        // Skip rows that look like headers (values match header text)\n        const budgetStr = String(budgetValue).trim().toLowerCase();\n        const impressionsStr = String(impressionsValue).trim().toLowerCase();\n        const placementsStr = String(placementsValue).trim().toLowerCase();\n\n        const isHeaderRow = (\n          budgetStr.includes('budget') || budgetStr.includes('cost') ||\n          impressionsStr.includes('impression') || impressionsStr.includes('grp') ||\n          placementsStr.includes('placement')\n        );\n\n        if (isHeaderRow) {\n          console.log(`  ‚è≠Ô∏è  Skipping header-like row at ${rowNum}`);\n          continue;\n        }\n\n        // Verify this is not a summary/total row\n        if (!this.isSummaryRow(worksheet, rowNum, headers)) {\n          console.log(`  ‚úÖ Found single-row campaign line at row ${rowNum}`);\n          campaignLineRanges.push({\n            masterRow: rowNum,\n            span: 1,\n            endRow: rowNum,\n          });\n          detectedRows.add(rowNum);\n        }\n      }\n    }\n\n    return campaignLineRanges.sort((a, b) => a.masterRow - b.masterRow);\n  }\n\n  /**\n   * Check if a row is a summary/total row (should be excluded)\n   */\n  private isSummaryRow(worksheet: ExcelJS.Worksheet, rowNumber: number, headers: string[]): boolean {\n    const row = worksheet.getRow(rowNumber);\n    const values: Record<string, any> = {};\n\n    headers.forEach((header, index) => {\n      const cell = row.getCell(index + 1);\n      values[header] = cell.value;\n    });\n\n    // Check for exclusion patterns in text fields\n    const textFields = [values['Channel'], values['Platform'], values['Campaign Details - Placements']];\n    const textContent = textFields\n      .filter(v => v)\n      .map(v => String(v).toLowerCase())\n      .join(' ');\n\n    for (const pattern of CAMPAIGN_LINE_DETECTION_CONFIG.EXCLUSION_PATTERNS) {\n      if (textContent.includes(pattern)) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Build campaign lines with audience-based ad group detection\n   */\n  private buildCampaignLines(\n    worksheet: ExcelJS.Worksheet,\n    headers: string[],\n    campaignLineRanges: CampaignLineRange[],\n    headerRow: number\n  ): CampaignLine[] {\n    const campaignLines: CampaignLine[] = [];\n\n    for (let index = 0; index < campaignLineRanges.length; index++) {\n      const range = campaignLineRanges[index];\n\n      try {\n        const campaignLine = this.buildCampaignLine(\n          worksheet,\n          headers,\n          range,\n          index\n        );\n\n        campaignLines.push(campaignLine);\n      } catch (error) {\n        this.addWarning(\n          'error',\n          `Failed to parse campaign line at row ${range.masterRow}: ${error.message}`,\n          undefined,\n          range.masterRow\n        );\n      }\n    }\n\n    return campaignLines;\n  }\n\n  /**\n   * Build a single campaign line with dynamic ad group detection\n   */\n  private buildCampaignLine(\n    worksheet: ExcelJS.Worksheet,\n    headers: string[],\n    range: CampaignLineRange,\n    campaignLineIndex: number\n  ): CampaignLine {\n    // Extract all rows in this campaign line\n    const rows: Record<string, any>[] = [];\n    for (let rowNum = range.masterRow; rowNum <= range.endRow; rowNum++) {\n      const rowData = this.extractRowData(worksheet, rowNum, headers);\n      rows.push(rowData);\n    }\n\n    // Get campaign-level data from first row\n    const firstRow = rows[0];\n\n    // Detect ad groups by grouping rows by audience\n    const adGroups = this.detectAdGroupsByAudience(rows, headers);\n\n    // Build campaign line\n    const campaignLine: CampaignLine = {\n      // Campaign-level fields (from first row)\n      channel: firstRow.channel || '',\n      platform: firstRow.platform || '',\n      mediaType: firstRow.mediaType,\n      objective: firstRow.objective || '',\n      language: firstRow.language,\n      target: firstRow.target,\n      startDate: firstRow.startDate || '',\n      endDate: firstRow.endDate || '',\n\n      // Budget information\n      grossBudget: firstRow.grossBudget,\n      netBudget: firstRow.netBudget,\n      estImpressions: firstRow.estImpressions,\n      estCpm: firstRow.estCpm,\n      adServing: firstRow.adServing,\n      dvCost: firstRow.dvCost,\n      buffer: firstRow.buffer,\n\n      // Campaign-level placements and naming\n      placements: firstRow.placements,\n      accuticsCampaignName: firstRow.accuticsCampaignName,\n\n      // Additional metadata\n      adFormat: firstRow.adFormat,\n      buyType: firstRow.buyType,\n      tagsRequired: firstRow.tagsRequired,\n\n      // Exclusion check\n      isExcluded: isExcludedChannel(firstRow.channel || ''),\n      excludedReason: getExclusionReason(firstRow.channel || ''),\n\n      // Ad groups (dynamically detected)\n      adGroups,\n\n      // Validation warnings\n      validationWarnings: [],\n\n      // Tracking metadata\n      _sourceRowNumbers: Array.from(\n        { length: range.span },\n        (_, i) => range.masterRow + i\n      ),\n      blockingChartRowCount: range.span,\n      stableIndex: campaignLineIndex,\n    };\n\n    // Validate campaign line\n    this.validateCampaignLine(campaignLine);\n\n    return campaignLine;\n  }\n\n  /**\n   * Detect ad groups by grouping rows by audience field\n   * Each unique audience value = 1 ad group with 5 creative lines\n   */\n  private detectAdGroupsByAudience(\n    rows: Record<string, any>[],\n    headers: string[]\n  ): AdGroup[] {\n    // Find audience column\n    const audienceField = this.findAudienceField(rows);\n\n    // Group rows by audience value\n    const rowsByAudience = new Map<string, Record<string, any>[]>();\n\n    for (const row of rows) {\n      const audienceValue =\n        row[audienceField] ||\n        AD_GROUP_DETECTION_CONFIG.DEFAULT_AD_GROUP_NAME;\n\n      if (!rowsByAudience.has(audienceValue)) {\n        rowsByAudience.set(audienceValue, []);\n      }\n      rowsByAudience.get(audienceValue)!.push(row);\n    }\n\n    // Build ad groups\n    const adGroups: AdGroup[] = [];\n\n    for (const [audienceName, audienceRows] of rowsByAudience.entries()) {\n      const adGroup = this.buildAdGroup(audienceName, audienceRows);\n      adGroups.push(adGroup);\n    }\n\n    return adGroups;\n  }\n\n  /**\n   * Find which field to use for audience grouping\n   */\n  private findAudienceField(rows: Record<string, any>[]): string {\n    // Try primary field first\n    if (rows.some(r => r[AD_GROUP_DETECTION_CONFIG.PRIMARY_GROUPING_FIELD])) {\n      return AD_GROUP_DETECTION_CONFIG.PRIMARY_GROUPING_FIELD;\n    }\n\n    // Try fallback fields\n    for (const field of AD_GROUP_DETECTION_CONFIG.FALLBACK_GROUPING_FIELDS) {\n      if (rows.some(r => r[field])) {\n        return field;\n      }\n    }\n\n    // Default to primary\n    return AD_GROUP_DETECTION_CONFIG.PRIMARY_GROUPING_FIELD;\n  }\n\n  /**\n   * Build a single ad group with exactly 5 creative lines\n   */\n  private buildAdGroup(\n    audienceName: string,\n    audienceRows: Record<string, any>[]\n  ): AdGroup {\n    // Get ad group-level data from first row\n    const firstRow = audienceRows[0];\n\n    // Always create exactly 5 creative lines\n    const creativeLines: CreativeLine[] = [];\n    for (let i = 0; i < ROW_EXPANSION_CONFIG.CREATIVES_PER_AD_GROUP; i++) {\n      const sourceRow = audienceRows[i] || {}; // Use empty object if fewer than 5 rows\n\n      creativeLines.push({\n        creativeName: sourceRow.creativeName,\n        creativeFormat: sourceRow.creativeFormat,\n        adFormat: sourceRow.adFormat,\n      });\n    }\n\n    return {\n      // Ad group-level fields\n      audience: audienceName,\n      accuticsCampaignName: firstRow.accuticsCampaignName,\n      targeting: firstRow.targeting,\n      target: firstRow.target,\n      kpi: firstRow.kpi,\n      kpiValue: firstRow.kpiValue,\n      placements: firstRow.placements,\n      measurement: firstRow.measurement,\n\n      // Creative lines (always 5)\n      creativeLines,\n    };\n  }\n\n  /**\n   * Extract row data and map to internal field names\n   */\n  private extractRowData(\n    worksheet: ExcelJS.Worksheet,\n    rowNumber: number,\n    headers: string[]\n  ): Record<string, any> {\n    const row = worksheet.getRow(rowNumber);\n    const data: Record<string, any> = {};\n\n    headers.forEach((header, index) => {\n      if (!header) return;\n\n      const cell = row.getCell(index + 1);\n      const internalField = getInternalFieldName(header);\n\n      if (internalField) {\n        let value = cell.value;\n\n        // Handle date formatting\n        // Excel stores dates as serial numbers (days since 1900-01-01) with no timezone info\n        // ExcelJS converts these to JavaScript Date objects\n        // To avoid timezone boundary issues, we add 12 hours before extracting date components\n        // This ensures we're safely in the middle of the calendar day regardless of timezone\n        if (value instanceof Date) {\n          // Add 12 hours (43200000 ms) to avoid timezone boundary issues\n          // If date is at midnight (any timezone), adding 12 hours keeps us on the same calendar day\n          const safeDate = new Date(value.getTime() + 12 * 60 * 60 * 1000);\n\n          // Extract UTC date components from the safe date\n          const year = safeDate.getUTCFullYear();\n          const month = String(safeDate.getUTCMonth() + 1).padStart(2, '0');\n          const day = String(safeDate.getUTCDate()).padStart(2, '0');\n\n          value = `${year}-${month}-${day}`;\n        } else if (typeof value === 'object' && value !== null) {\n          // Handle Excel rich text\n          value = (value as any).text || String(value);\n        }\n\n        data[internalField] = value;\n      }\n    });\n\n    return data;\n  }\n\n  /**\n   * Find column index by trying multiple possible names\n   */\n  private findColumnIndex(headers: string[], possibleNames: string[]): number {\n    for (const name of possibleNames) {\n      const index = headers.findIndex(h => h === name);\n      if (index !== -1) return index;\n    }\n\n    // Try normalized matching\n    const normalizedPossibleNames = possibleNames.map(n => normalizeFieldName(n));\n    for (let i = 0; i < headers.length; i++) {\n      const normalized = normalizeFieldName(headers[i]);\n      if (normalizedPossibleNames.includes(normalized)) {\n        return i;\n      }\n    }\n\n    return -1;\n  }\n\n  /**\n   * Validate campaign line and add warnings\n   */\n  private validateCampaignLine(campaignLine: CampaignLine): void {\n    // Check required fields\n    if (!campaignLine.channel) {\n      campaignLine.validationWarnings = campaignLine.validationWarnings || [];\n      campaignLine.validationWarnings.push({\n        severity: 'warning',\n        message: 'Missing channel',\n        field: 'channel',\n      });\n    }\n\n    if (!campaignLine.platform) {\n      campaignLine.validationWarnings = campaignLine.validationWarnings || [];\n      campaignLine.validationWarnings.push({\n        severity: 'warning',\n        message: 'Missing platform',\n        field: 'platform',\n      });\n    }\n\n    if (!campaignLine.startDate || !campaignLine.endDate) {\n      campaignLine.validationWarnings = campaignLine.validationWarnings || [];\n      campaignLine.validationWarnings.push({\n        severity: 'warning',\n        message: 'Missing start or end date',\n        field: 'dates',\n      });\n    }\n\n    if (campaignLine.adGroups.length === 0) {\n      campaignLine.validationWarnings = campaignLine.validationWarnings || [];\n      campaignLine.validationWarnings.push({\n        severity: 'error',\n        message: 'No ad groups detected',\n      });\n    }\n  }\n\n  /**\n   * Add validation warning to global warnings list\n   */\n  private addWarning(\n    severity: 'error' | 'warning' | 'info',\n    message: string,\n    field?: string,\n    rowNumber?: number\n  ): void {\n    this.validationWarnings.push({\n      severity,\n      message,\n      field,\n      rowNumber,\n    });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1839, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/blockingChartTemplates.ts"],"sourcesContent":["import ExcelJS from \"exceljs\";\nimport { TEMPLATE_CONFIG } from \"./config\";\n\nexport interface BlockingChartTemplate {\n  id: string;\n  name: string;\n  description: string;\n  // Column mappings: template column name ‚Üí standard field name\n  columnMappings: Record<string, string>;\n  // Detection rules to identify this template\n  detectionRules: {\n    requiredColumns: string[];  // Must have these columns\n    optionalColumns?: string[]; // May have these\n    sheetNamePattern?: RegExp;  // Sheet name must match\n  };\n  // Parser-specific config\n  config?: {\n    headerRowHint?: number;     // Likely row number for headers\n    skipRows?: number;          // Rows to skip at top\n    customParsing?: (worksheet: ExcelJS.Worksheet) => any;\n  };\n}\n\nexport const blockingChartTemplates: BlockingChartTemplate[] = [\n  {\n    id: \"unilever-standard\",\n    name: \"Unilever Standard\",\n    description: \"Standard Unilever blocking chart format\",\n    columnMappings: {\n      \"Channel\": \"channel\",\n      \"Tactic\": \"tactic\",\n      \"Platform\": \"platform\",\n      \"Objective\": \"objective\",\n      \"Placements\": \"placements\",\n      \"Optimization KPI\": \"optimizationKpi\",\n      \"Demo\": \"demo\",\n      \"Targeting\": \"targeting\",\n      \"Language\": \"language\",\n      \"Accutics Campaign Name\": \"accuticsCampaignName\",\n      \"Accutics Ad Set Name\": \"accuticsAdSetName\",\n      \"CPM/CPP\": \"cpmCpp\",\n      \"Impressions/GRPs\": \"impressionsGrps\",\n      \"Start Date\": \"startDate\",\n      \"End Date\": \"endDate\",\n      \"Media Cost\": \"mediaCost\",\n      \"Ad Serving\": \"adServing\",\n      \"DV Cost\": \"dvCost\",\n      \"Media Fee Total\": \"mediaFeeTotal\",\n      \"Working Media Budget\": \"workingMediaBudget\",\n    },\n    detectionRules: {\n      requiredColumns: [\"Channel\", \"Tactic\", \"Platform\"],\n      optionalColumns: [\"Accutics Campaign Name\", \"Working Media Budget\"],\n    },\n  },\n  {\n    id: \"unilever-extended\",\n    name: \"Unilever Extended Format\",\n    description: \"Extended blocking chart with additional depth\",\n    columnMappings: {\n      // All standard mappings from above, PLUS extended fields:\n      \"Channel\": \"channel\",\n      \"Tactic\": \"tactic\",\n      \"Platform\": \"platform\",\n      \"Objective\": \"objective\",\n      \"Sub-Objective\": \"subObjective\",           // NEW\n      \"Placements\": \"placements\",\n      \"Placement Details\": \"placementDetails\",   // NEW\n      \"Optimization KPI\": \"optimizationKpi\",\n      \"KPI Target\": \"kpiTarget\",                 // NEW\n      \"Demo\": \"demo\",\n      \"Demo Details\": \"demoDetails\",             // NEW\n      \"Targeting\": \"targeting\",\n      \"Targeting Strategy\": \"targetingStrategy\", // NEW\n      \"Language\": \"language\",\n      \"Market\": \"market\",                        // NEW\n      \"Region\": \"region\",                        // NEW\n      \"Accutics Campaign Name\": \"accuticsCampaignName\",\n      \"Accutics Ad Set Name\": \"accuticsAdSetName\",\n      \"Creative Strategy\": \"creativeStrategy\",   // NEW\n      \"Creative Format\": \"creativeFormat\",       // NEW\n      \"CPM/CPP\": \"cpmCpp\",\n      \"Impressions/GRPs\": \"impressionsGrps\",\n      \"Frequency Cap\": \"frequencyCap\",           // NEW\n      \"Start Date\": \"startDate\",\n      \"End Date\": \"endDate\",\n      \"Flight Pattern\": \"flightPattern\",         // NEW\n      \"Media Cost\": \"mediaCost\",\n      \"Production Cost\": \"productionCost\",       // NEW\n      \"Ad Serving\": \"adServing\",\n      \"DV Cost\": \"dvCost\",\n      \"Media Fee Total\": \"mediaFeeTotal\",\n      \"Working Media Budget\": \"workingMediaBudget\",\n      \"Vendor\": \"vendor\",                        // NEW\n      \"PO Number\": \"poNumber\",                   // NEW\n      \"Budget Category\": \"budgetCategory\",       // NEW\n      \"Campaign Type\": \"campaignType\",           // NEW\n    },\n    detectionRules: {\n      // If we see any of these \"extended\" columns, it's the extended format\n      requiredColumns: [\"Channel\", \"Tactic\", \"Platform\"],\n      optionalColumns: [\"Sub-Objective\", \"Creative Strategy\", \"Flight Pattern\", \"Vendor\", \"KPI Target\", \"Budget Category\"],\n    },\n  },\n];\n\n/**\n * Auto-detect which template a blocking chart uses based on its headers\n */\nexport function detectBlockingChartTemplate(\n  headers: string[]\n): BlockingChartTemplate | null {\n  const normalizedHeaders = headers.map(h => h.trim().toLowerCase());\n  \n  console.log('üîç Detecting blocking chart template...');\n  console.log('Headers found:', headers);\n  \n  // Check extended template first (more specific)\n  for (let i = blockingChartTemplates.length - 1; i >= 0; i--) {\n    const template = blockingChartTemplates[i];\n    \n    // Check required columns\n    const hasAllRequired = template.detectionRules.requiredColumns.every(col =>\n      normalizedHeaders.some(h => h === col.toLowerCase())\n    );\n    \n    if (!hasAllRequired) {\n      continue;\n    }\n    \n    // For extended template, check if it has at least minimum optional \"extended\" columns\n    if (template.id === 'unilever-extended' && template.detectionRules.optionalColumns) {\n      const extendedColumnsFound = template.detectionRules.optionalColumns.filter(col =>\n        normalizedHeaders.some(h => h === col.toLowerCase())\n      );\n\n      if (extendedColumnsFound.length >= TEMPLATE_CONFIG.MIN_EXTENDED_COLUMNS) {\n        console.log(`‚úÖ Detected template: ${template.name}`);\n        console.log(`Extended columns found: ${extendedColumnsFound.join(', ')}`);\n        return template;\n      }\n    }\n    \n    // For standard template, just check required columns\n    if (template.id === 'unilever-standard') {\n      console.log(`‚úÖ Detected template: ${template.name}`);\n      return template;\n    }\n  }\n  \n  console.log('‚ö†Ô∏è No template matched, will use auto-normalization');\n  return null; // No template matched\n}\n\n/**\n * Get the mapped field name for a header using the detected template\n */\nexport function getMappedFieldName(\n  header: string,\n  template: BlockingChartTemplate | null,\n  fallbackNormalizer: (header: string) => string\n): string {\n  if (template && template.columnMappings[header]) {\n    return template.columnMappings[header];\n  }\n  \n  // Fall back to auto-normalization\n  return fallbackNormalizer(header);\n}\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1990, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/categorization.ts"],"sourcesContent":["import { CATEGORIZATION_CONFIG } from \"./config\";\n\n/**\n * Categorization input - can be a full CampaignLine or minimal row data\n */\nexport interface CategorizationInput {\n  channel?: string;\n  platform?: string;\n  mediaType?: string;\n  placements?: string;\n  adFormat?: string;\n  isExcluded?: boolean;\n  excludedReason?: string;\n}\n\n/**\n * Categorization result\n */\nexport interface CategorizationResult {\n  tab: string;\n  type: string;\n  reason?: string;\n}\n\n/**\n * Tab information for Excel worksheet selection\n */\nexport interface TabInfo {\n  index: number;\n  name: string;\n  rowCount?: number;\n}\n\n/**\n * Unified categorization logic used by both frontend and backend\n * Determines which traffic sheet tab a campaign line belongs to\n */\nexport function categorizeLine(input: CategorizationInput): CategorizationResult {\n  const channel = (input.channel || '').toLowerCase();\n  const platform = (input.platform || '').toLowerCase();\n  const mediaType = (input.mediaType || '').toLowerCase();\n  const placements = (input.placements || '').toLowerCase();\n  const adFormat = (input.adFormat || '').toLowerCase();\n\n  // Check for excluded campaigns FIRST (highest priority)\n  // Either check the isExcluded flag OR detect by keywords\n  if (input.isExcluded) {\n    return {\n      tab: 'Excluded',\n      type: 'non-digital',\n      reason: input.excludedReason\n    };\n  }\n\n  // Also check for excluded channel keywords directly (OOH, TV, Radio, Print)\n  const excludedCategories = CATEGORIZATION_CONFIG.EXCLUDED_CHANNEL_KEYWORDS;\n\n  // Check OOH\n  for (const keyword of excludedCategories.OOH) {\n    if (channel.includes(keyword) ||\n        platform.includes(keyword) ||\n        placements.includes(keyword) ||\n        adFormat.includes(keyword)) {\n      return { tab: 'Excluded', type: 'non-digital', reason: 'OOH' };\n    }\n  }\n\n  // Check TV (but exclude CTV/Connected TV which are digital)\n  for (const keyword of excludedCategories.TV) {\n    if ((channel.includes(keyword) ||\n         platform.includes(keyword) ||\n         placements.includes(keyword) ||\n         adFormat.includes(keyword)) &&\n        !channel.includes('ctv') &&\n        !channel.includes('connected tv') &&\n        !platform.includes('ctv') &&\n        !platform.includes('connected tv')) {\n      return { tab: 'Excluded', type: 'non-digital', reason: 'TV' };\n    }\n  }\n\n  // Check Radio\n  for (const keyword of excludedCategories.RADIO) {\n    if (channel.includes(keyword) ||\n        platform.includes(keyword) ||\n        placements.includes(keyword) ||\n        adFormat.includes(keyword)) {\n      return { tab: 'Excluded', type: 'non-digital', reason: 'Radio' };\n    }\n  }\n\n  // Check Print\n  for (const keyword of excludedCategories.PRINT) {\n    if (channel.includes(keyword) ||\n        platform.includes(keyword) ||\n        placements.includes(keyword) ||\n        adFormat.includes(keyword)) {\n      return { tab: 'Excluded', type: 'non-digital', reason: 'Print' };\n    }\n  }\n\n  // Check for Brand Say Digital keywords (second priority)\n  // This ensures audio, programmatic, digital video, digital display route correctly\n  const isBrandSayDigital = CATEGORIZATION_CONFIG.BRAND_SAY_DIGITAL_KEYWORDS.some(\n    keyword => channel.includes(keyword) || mediaType.includes(keyword)\n  );\n\n  if (isBrandSayDigital) {\n    return { tab: 'Brand Say Digital', type: 'media' };\n  }\n\n  // Check for influencer keyword (third priority)\n  // Check in placements, adFormat, channel, and platform\n  const isInfluencer = CATEGORIZATION_CONFIG.INFLUENCER_KEYWORDS.some(\n    keyword =>\n      placements.includes(keyword.toLowerCase()) ||\n      adFormat.includes(keyword.toLowerCase()) ||\n      channel.includes(keyword.toLowerCase()) ||\n      platform.includes(keyword.toLowerCase())\n  );\n\n  // Check if it's a social platform (fourth priority)\n  // Check platform, channel, placements, and adFormat to catch all cases\n  const isSocialPlatform = CATEGORIZATION_CONFIG.SOCIAL_PLATFORMS.some(socialPlatform =>\n    platform.includes(socialPlatform.toLowerCase()) ||\n    channel.includes(socialPlatform.toLowerCase()) ||\n    placements.includes(socialPlatform.toLowerCase()) ||\n    adFormat.includes(socialPlatform.toLowerCase())\n  );\n\n  // Special case: Pinterest only\n  // Pinterest is the ONLY social platform where influencer content goes to Brand Say Social\n  const isPinterest = platform.includes('pinterest') || platform.includes('pin') ||\n                      channel.includes('pinterest') || channel.includes('pin') ||\n                      placements.includes('pinterest') || placements.includes('pin') ||\n                      adFormat.includes('pinterest') || adFormat.includes('pin');\n\n  // Decision matrix for social platforms with influencer:\n  // - Pinterest + Influencer ‚Üí Brand Say Social (brand-created influencer content)\n  // - Meta/TikTok/Other Social + Influencer ‚Üí Other Say Social (actual influencers)\n  // - Any Social Platform + NO Influencer ‚Üí Brand Say Social (regular paid social)\n  if (isSocialPlatform) {\n    if (isInfluencer && !isPinterest) {\n      // Meta, TikTok, etc. with influencer ‚Üí Other Say Social\n      return { tab: 'Other Say Social', type: 'media' };\n    } else {\n      // Pinterest (with or without influencer) OR any social without influencer ‚Üí Brand Say Social\n      return { tab: 'Brand Say Social', type: 'media' };\n    }\n  }\n\n  // If it's influencer content on a NON-social platform, route to Other Say Social\n  if (isInfluencer) {\n    return { tab: 'Other Say Social', type: 'media' };\n  }\n\n  // Default to Brand Say Digital for non-social, non-influencer (programmatic, display, video, audio, etc.)\n  return { tab: 'Brand Say Digital', type: 'media' };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2107, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/demographicExtraction.ts"],"sourcesContent":["/**\n * Demographic extraction utilities\n * Extracts demographic codes (W25-49, M18-44, A18-65) from Target field\n */\n\nimport { DEMOGRAPHIC_CONFIG } from './config';\n\n/**\n * Extract demographic code from Target field\n *\n * Looks for patterns like:\n * - W25-49 (Women 25-49)\n * - M18-44 (Men 18-44)\n * - A18-65 (Adults 18-65)\n * - F21-35 (Females 21-35)\n *\n * Returns the first matching demographic code found, or 'A18+' if none found.\n *\n * @param target - The target field value from blocking chart\n * @returns Demographic code (e.g., \"W25-49\", \"M18-44\", or \"A18+\")\n *\n * @example\n * extractDemographic(\"Broad W25-49 + Costco interest\") // Returns \"W25-49\"\n * extractDemographic(\"Healthy-ish Hustlers (M18-44)\") // Returns \"M18-44\"\n * extractDemographic(\"Casual Quenchers (A18-65)\") // Returns \"A18-65\"\n * extractDemographic(\"18-54\\nBeauty & Personal Care\") // Returns \"A18+\" (no gender code)\n * extractDemographic(undefined) // Returns \"A18+\"\n */\nexport function extractDemographic(target: string | undefined): string {\n  if (!target) {\n    return DEMOGRAPHIC_CONFIG.DEFAULT_DEMO;\n  }\n\n  const targetStr = String(target);\n\n  // Reset regex state (important for global regex)\n  DEMOGRAPHIC_CONFIG.DEMO_PATTERN.lastIndex = 0;\n\n  // Find all demographic patterns in the string\n  const matches = targetStr.matchAll(DEMOGRAPHIC_CONFIG.DEMO_PATTERN);\n  const matchArray = Array.from(matches);\n\n  if (matchArray.length === 0) {\n    return DEMOGRAPHIC_CONFIG.DEFAULT_DEMO;\n  }\n\n  // Return first match in format: W25-49\n  const firstMatch = matchArray[0];\n  const genderCode = firstMatch[1];  // W, M, A, F\n  const lowerAge = firstMatch[2];     // 25, 18, etc.\n  const upperAge = firstMatch[3];     // 49, 44, etc.\n\n  return `${genderCode}${lowerAge}-${upperAge}`;\n}\n\n/**\n * Get the full gender description from a gender code\n *\n * @param genderCode - Single character gender code (W, M, A, F)\n * @returns Full gender description\n *\n * @example\n * getGenderDescription('W') // Returns \"Women\"\n * getGenderDescription('M') // Returns \"Men\"\n * getGenderDescription('A') // Returns \"Adults\"\n */\nexport function getGenderDescription(genderCode: string): string {\n  const upperCode = genderCode.toUpperCase() as keyof typeof DEMOGRAPHIC_CONFIG.GENDER_CODES;\n  return DEMOGRAPHIC_CONFIG.GENDER_CODES[upperCode] || 'Adults';\n}\n\n/**\n * Parse a demographic code into its components\n *\n * @param demographic - Demographic code (e.g., \"W25-49\")\n * @returns Object with gender, lowerAge, upperAge\n *\n * @example\n * parseDemographic(\"W25-49\") // Returns { gender: \"W\", genderDesc: \"Women\", lowerAge: 25, upperAge: 49 }\n * parseDemographic(\"A18+\") // Returns { gender: \"A\", genderDesc: \"Adults\", lowerAge: 18, upperAge: undefined }\n */\nexport function parseDemographic(demographic: string): {\n  gender: string;\n  genderDesc: string;\n  lowerAge: number;\n  upperAge?: number;\n} {\n  // Handle \"A18+\" format\n  const plusMatch = demographic.match(/^([MWFA])(\\d+)\\+$/);\n  if (plusMatch) {\n    const gender = plusMatch[1];\n    return {\n      gender,\n      genderDesc: getGenderDescription(gender),\n      lowerAge: parseInt(plusMatch[2], 10),\n      upperAge: undefined,\n    };\n  }\n\n  // Handle \"W25-49\" format\n  const rangeMatch = demographic.match(/^([MWFA])(\\d+)-(\\d+)$/);\n  if (rangeMatch) {\n    const gender = rangeMatch[1];\n    return {\n      gender,\n      genderDesc: getGenderDescription(gender),\n      lowerAge: parseInt(rangeMatch[2], 10),\n      upperAge: parseInt(rangeMatch[3], 10),\n    };\n  }\n\n  // Fallback\n  return {\n    gender: 'A',\n    genderDesc: 'Adults',\n    lowerAge: 18,\n    upperAge: undefined,\n  };\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;AAED;;AAuBO,SAAS,mBAAmB,MAA0B;IAC3D,IAAI,CAAC,QAAQ;QACX,OAAO,6JAAkB,CAAC,YAAY;IACxC;IAEA,MAAM,YAAY,OAAO;IAEzB,iDAAiD;IACjD,6JAAkB,CAAC,YAAY,CAAC,SAAS,GAAG;IAE5C,8CAA8C;IAC9C,MAAM,UAAU,UAAU,QAAQ,CAAC,6JAAkB,CAAC,YAAY;IAClE,MAAM,aAAa,MAAM,IAAI,CAAC;IAE9B,IAAI,WAAW,MAAM,KAAK,GAAG;QAC3B,OAAO,6JAAkB,CAAC,YAAY;IACxC;IAEA,uCAAuC;IACvC,MAAM,aAAa,UAAU,CAAC,EAAE;IAChC,MAAM,aAAa,UAAU,CAAC,EAAE,EAAG,aAAa;IAChD,MAAM,WAAW,UAAU,CAAC,EAAE,EAAM,eAAe;IACnD,MAAM,WAAW,UAAU,CAAC,EAAE,EAAM,eAAe;IAEnD,OAAO,GAAG,aAAa,SAAS,CAAC,EAAE,UAAU;AAC/C;AAaO,SAAS,qBAAqB,UAAkB;IACrD,MAAM,YAAY,WAAW,WAAW;IACxC,OAAO,6JAAkB,CAAC,YAAY,CAAC,UAAU,IAAI;AACvD;AAYO,SAAS,iBAAiB,WAAmB;IAMlD,uBAAuB;IACvB,MAAM,YAAY,YAAY,KAAK,CAAC;IACpC,IAAI,WAAW;QACb,MAAM,SAAS,SAAS,CAAC,EAAE;QAC3B,OAAO;YACL;YACA,YAAY,qBAAqB;YACjC,UAAU,SAAS,SAAS,CAAC,EAAE,EAAE;YACjC,UAAU;QACZ;IACF;IAEA,yBAAyB;IACzB,MAAM,aAAa,YAAY,KAAK,CAAC;IACrC,IAAI,YAAY;QACd,MAAM,SAAS,UAAU,CAAC,EAAE;QAC5B,OAAO;YACL;YACA,YAAY,qBAAqB;YACjC,UAAU,SAAS,UAAU,CAAC,EAAE,EAAE;YAClC,UAAU,SAAS,UAAU,CAAC,EAAE,EAAE;QACpC;IACF;IAEA,WAAW;IACX,OAAO;QACL,QAAQ;QACR,YAAY;QACZ,UAAU;QACV,UAAU;IACZ;AACF","debugId":null}},
    {"offset": {"line": 2179, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/shared/excel/index.ts"],"sourcesContent":["/**\n * Shared Excel Processing Module\n * Main entry point for blocking chart parsing and traffic sheet generation\n * Used by both desktop (Electron) and web implementations\n *\n * This is the SINGLE SOURCE OF TRUTH for all Excel processing logic.\n * Both desktop and web applications import from this shared package.\n */\n\n// Main processing functions and classes\nexport { TrafficSheetGenerator } from './trafficSheetWriter';\nexport { BlockingChartParser } from './parser/BlockingChartParser';\n\n// Template detection and management\nexport {\n  detectBlockingChartTemplate,\n  type BlockingChartTemplate,\n} from './blockingChartTemplates';\n\n// Categorization logic\nexport {\n  categorizeLine,\n  type CategorizationInput,\n  type CategorizationResult,\n  type TabInfo,\n} from './categorization';\n\n// Demographic extraction\nexport { extractDemographic } from './demographicExtraction';\n\n// Utilities\nexport {\n  normalizeFieldName,\n  normalizeFieldNameCamelCase,\n  createFieldNameMap,\n} from './utils/FieldNormalizer';\n\nexport {\n  getTrafficSheetTab as getPlatformTab,\n  getPlatformCategory,\n  getDefaultPlacements,\n  isExcludedChannel as isPlatformExcluded,\n  getExclusionReason as getPlatformExclusionReason,\n  isSocialPlatform,\n  isProgrammaticPlatform,\n} from './utils/PlatformClassifier';\n\nexport {\n  BLOCKING_CHART_COLUMNS,\n  CAMPAIGN_LINE_INDICATORS,\n  BLOCKING_CHART_FIELD_MAPPINGS,\n  TRAFFIC_SHEET_FIELD_MAPPINGS,\n  getInternalFieldName,\n  getTrafficSheetColumnName,\n  buildColumnIndexMap,\n  mapBlockingChartRowToInternal,\n} from './utils/FieldMapper';\n\n// Configuration constants\nexport {\n  ROW_EXPANSION_CONFIG,\n  DEMOGRAPHIC_CONFIG,\n  TRAFFIC_SHEET_CONFIG,\n  PARSING_CONFIG,\n  CAMPAIGN_LINE_DETECTION_CONFIG,\n  AD_GROUP_DETECTION_CONFIG,\n  CATEGORIZATION_CONFIG,\n  STYLE_CONFIG,\n  VALIDATION_CONFIG,\n  DATE_CONFIG,\n  TEMPLATE_CONFIG,\n} from './config';\n\n// Type definitions\nexport type {\n  ParsedBlockingChart,\n  CampaignLine,\n  AdGroup,\n  CreativeLine,\n  ValidationWarning,\n  CampaignLineRange,\n  MergeInfo,\n  CategorizedCampaignLines,\n  TrafficSheetTab,\n  TrafficSheetRow,\n  ExcelStyleInfo,\n} from './types';\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC,GAED,wCAAwC;;AACxC;AACA;AAEA,oCAAoC;AACpC;AAKA,uBAAuB;AACvB;AAOA,yBAAyB;AACzB;AAEA,YAAY;AACZ;AAMA;AAUA;AAWA,0BAA0B;AAC1B","debugId":null}},
    {"offset": {"line": 2221, "column": 0}, "map": {"version":3,"sources":["file:///Users/lucusdato/Documents/Dev/ShortStaffed%20MediaTools/packages/web/app/api/traffic-sheet/generate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { BlockingChartParser, TrafficSheetGenerator } from \"@quickclick/shared/excel\";\nimport path from \"path\";\nimport fs from \"fs/promises\";\n\nexport async function POST(request: NextRequest) {\n  try {\n    const formData = await request.formData();\n    const blockingChartFile = formData.get(\"blockingChart\") as File;\n    const deletedRowsJson = formData.get(\"deletedRows\") as string | null;\n\n    if (!blockingChartFile) {\n      return NextResponse.json(\n        { error: \"Blocking chart file is required\" },\n        { status: 400 }\n      );\n    }\n\n    // Parse deleted rows if provided\n    const deletedRows: number[] = deletedRowsJson ? JSON.parse(deletedRowsJson) : [];\n    console.log(`üóëÔ∏è  Deleted rows from frontend: ${deletedRows.length > 0 ? deletedRows.join(', ') : 'none'}`);\n\n    // Convert blocking chart to ArrayBuffer\n    const blockingChartBuffer = await blockingChartFile.arrayBuffer();\n\n    // Parse the blocking chart using new shared parser\n    console.log('üîÑ Generate - Parsing blocking chart...');\n    const parser = new BlockingChartParser();\n    const parsedData = await parser.parse(blockingChartBuffer);\n\n    console.log('‚úÖ Parsed blocking chart');\n    console.log('  Campaign lines:', parsedData.campaignLines.length);\n    console.log('  Validation warnings:', parsedData.validationWarnings?.length || 0);\n\n    // Filter out deleted rows if any\n    if (deletedRows.length > 0 && parsedData.campaignLines.length > 0) {\n      const originalCount = parsedData.campaignLines.length;\n      console.log(`üóëÔ∏è  Original campaign lines: ${originalCount}`);\n\n      parsedData.campaignLines = parsedData.campaignLines.filter((line, index) => {\n        const shouldKeep = !deletedRows.includes(index);\n        if (!shouldKeep) {\n          console.log(`  ‚ùå Removing campaign line at index ${index}`);\n        }\n        return shouldKeep;\n      });\n\n      console.log(`üóëÔ∏è  After filtering: ${parsedData.campaignLines.length} (removed ${originalCount - parsedData.campaignLines.length})`);\n    }\n\n    // Check if we have any campaign lines to process\n    if (parsedData.campaignLines.length === 0) {\n      return NextResponse.json(\n        { error: 'No campaign lines found in blocking chart' },\n        { status: 400 }\n      );\n    }\n\n    // Load the built-in template\n    const templatePath = path.join(\n      process.cwd(),\n      \"public\",\n      \"templates\",\n      \"unilever-traffic-sheet-template.xlsx\"\n    );\n\n    let templateBuffer: ArrayBuffer | undefined;\n    try {\n      const templateFile = await fs.readFile(templatePath);\n      // Convert Node.js Buffer to ArrayBuffer\n      templateBuffer = templateFile.buffer.slice(\n        templateFile.byteOffset,\n        templateFile.byteOffset + templateFile.byteLength\n      ) as ArrayBuffer;\n      console.log('‚úÖ Template file read successfully');\n    } catch (error) {\n      console.warn('‚ö†Ô∏è  Failed to read template file, will create from scratch:', error?.message || error);\n    }\n\n    // Generate the traffic sheet using new shared generator\n    console.log('üèóÔ∏è  Generating traffic sheet...');\n    const generator = new TrafficSheetGenerator();\n    const workbook = await generator.generate(parsedData, templateBuffer);\n\n    // Write workbook to buffer\n    const buffer = await workbook.xlsx.writeBuffer();\n\n    console.log('‚úÖ Traffic sheet generated successfully');\n    console.log('  Buffer size:', buffer.byteLength, 'bytes');\n\n    // Return the generated Excel file\n    return new NextResponse(Buffer.from(buffer), {\n      status: 200,\n      headers: {\n        \"Content-Type\":\n          \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n        \"Content-Disposition\": `attachment; filename=\"traffic-sheet-${Date.now()}.xlsx\"`,\n      },\n    });\n  } catch (error) {\n    console.error(\"Error generating traffic sheet:\", error);\n    return NextResponse.json(\n      {\n        error: \"Failed to generate traffic sheet\",\n        details: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}